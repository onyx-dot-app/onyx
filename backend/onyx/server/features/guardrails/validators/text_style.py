from onyx.llm.interfaces import LLM
from onyx.utils.logger import setup_logger

logger = setup_logger()


def llm_analyzer(
    llm: LLM,
    text: str,
    text_styles: list[str],
) -> str:
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç —Å—Ç–∏–ª—å —Ç–µ–∫—Å—Ç–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç LLM
    —Å–æ–≥–ª–∞—Å–Ω–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º.

    –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–µ–∫—Å—Ç —É–∫–∞–∑–∞–Ω–Ω—ã–º —Å—Ç–∏–ª—è–º –æ–±—â–µ–Ω–∏—è.
    –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç - –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç –µ–≥–æ, —Å–æ—Ö—Ä–∞–Ω—è—è —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ,
    –Ω–æ –∏–∑–º–µ–Ω—è—è —Å—Ç–∏–ª–∏—Å—Ç–∏–∫—É. –ï—Å–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª
    """

    prompt = f"""
        –¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É —Å—Ç–∏–ª—è –æ–±—â–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–µ–∫—Å—Ç —Ç—Ä–µ–±—É–µ–º—ã–º
        —Å—Ç–∏–ª—è–º –æ–±—â–µ–Ω–∏—è. –ï—Å–ª–∏ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç - –∏–∑–º–µ–Ω–∏ —Å—Ç–∏–ª—å —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç - –æ—Å—Ç–∞–≤—å –æ—Ä–∏–≥–∏–Ω–∞–ª.

        –¢–ï–ö–°–¢ –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê: "{text}"

        –¢–†–ï–ë–£–ï–ú–´–ï –°–¢–ò–õ–ò –û–ë–©–ï–ù–ò–Ø –î–õ–Ø –ü–†–û–í–ï–†–ö–ò: {text_styles}

        –ü–†–ê–í–ò–õ–ê, –û–¢ –ö–û–¢–û–†–´–• –°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ï–ù–û –û–¢–•–û–î–ò–¢–¨:
        1. –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±—É–µ–º—ã–º —Å—Ç–∏–ª—è–º –æ–±—â–µ–Ω–∏—è - –≤–µ—Ä–Ω–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
        2. –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –ù–ï —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±—É–µ–º—ã–º —Å—Ç–∏–ª—è–º –æ–±—â–µ–Ω–∏—è - –ø–µ—Ä–µ–ø–∏—à–∏ –µ–≥–æ, —Å–æ—Ö—Ä–∞–Ω—è—è:
            - –ü–æ–ª–Ω—ã–π —Å–º—ã—Å–ª –∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ;
            - –í—Å–µ —Ñ–∞–∫—Ç—ã –∏ –¥–µ—Ç–∞–ª–∏;
            - –û—Å–Ω–æ–≤–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–æ–æ–±—â–µ–Ω–∏—è;
            - –í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ;
        
        –ó–ê–ü–†–ï–©–ï–ù–û:
        - –∑–∞–ø—Ä–µ—â–µ–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∫ —Å–æ–æ–±—â–µ–Ω–∏—é —Å–≤–æ–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏;
        - –∑–∞–ø—Ä–µ—â–µ–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∫ —Å–æ–æ–±—â–µ–Ω–∏—é —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∏ –Ω–æ–≤–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞;
        - –∑–∞–ø—Ä–µ—â–µ–Ω–æ –æ–±–æ—Ä–∞—á–∏–≤–∞—Ç—å –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç –≤ –∫–∞–≤—ã—á–∫–∏;
        - –∑–∞–ø—Ä–µ—â–µ–Ω–æ –ø–∏—Å–∞—Ç—å –æ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –∫ —Ç–µ–∫—Å—Ç—É;

        –í–ï–†–ù–ò –¢–û–õ–¨–ö–û –§–ò–ù–ê–õ–¨–ù–´–ô –¢–ï–ö–°–¢.

        –¢–í–û–ô –û–¢–í–ï–¢, –§–ò–ù–ê–õ–¨–ù–´–ô –¢–ï–ö–°–¢:
        """

    try:

        response = llm.invoke(prompt=prompt)
        result_text = response.content.strip()

        return result_text

    except Exception as e:
        logger.error(
            "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Å—Ç–∏–ª—è –æ—Ç–≤–µ—Ç–∞ LLM: %s", repr(e)
        )
        return text


def validate_text_style(
    llm: LLM,
    text: str,
    config: dict,
) -> str:

    text_styles = config.get("text_styles")

    if not text_styles:
        return text

    validated_text = llm_analyzer(
        llm=llm, text=text, text_styles=text_styles
    )

    return validated_text


if __name__=="__main__":
    from contextlib import contextmanager
    from sqlalchemy import create_engine, select
    from sqlalchemy.orm import sessionmaker

    from onyx.db.models import LLMProvider
    from onyx.llm.factory import llm_from_provider

    def get_test_db_connection_string() -> str:
        """–ò—Å–ø–æ–ª—å–∑—É–µ–º psycopg2 –≤–º–µ—Å—Ç–æ asyncpg"""
        return "postgresql://postgres:password@127.0.0.1:5432/postgres"


    @contextmanager
    def get_test_session():
        connection_string = get_test_db_connection_string()
        engine = create_engine(connection_string)
        Session = sessionmaker(bind=engine)
        session = Session()

        try:
            yield session
            session.commit()
        except Exception:
            session.rollback()
            raise
        finally:
            session.close()


    with get_test_session() as db_session:
        stmt = (
            select(LLMProvider)
            .where(
                LLMProvider.name == "ollama_dev",
            )
        )

        llm_db: LLMProvider = db_session.scalars(stmt).unique().one_or_none()
        llm = llm_from_provider(
            model_name=llm_db.default_model_name,
            llm_provider=llm_db,
        )
        print(llm.__dict__)

        # text = "–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —á—É–∂–æ–º—É —Å–µ–π—Ñ—É, —Ç–µ–±–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ.."
        text = """
        –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω –Ω–∞:

        –ü–æ—á—Ç–∞: test@gmail.com
        –¢–µ–ª–µ—Ñ–æ–Ω: 8 800 111 22 33
        –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –±—É–∫–µ—Ç

        –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞:
        –í—ã –≤—ã–±—Ä–∞–ª–∏ –±—É–∫–µ—Ç "***". –≠—Ç–æ —Å—Ç–∏–ª—å–Ω—ã–π –∏ –Ω–µ–æ–±—ã—á–Ω—ã–π –±—É–∫–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥–æ–π–¥–µ—Ç –¥–ª—è —Ç–µ—Ö, 
        –∫—Ç–æ —Ü–µ–Ω–∏—Ç –∫—Ä–µ–∞—Ç–∏–≤ –∏ —Å–º–µ–ª–æ—Å—Ç—å –≤ –ø–æ–¥–∞—Ä–∫–∞—Ö. –ë—É–∫–µ—Ç —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —ç–ª–µ–≥–∞–Ω—Ç–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤, 
        –¥–æ–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–µ—Ç –µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å.
        
        –ó–∞—è–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≤—ã–±–æ—Ä! üå∏
        """
        config = {
            "text_styles": ["–ì—Ä—É–±–∏—è–Ω"],
        }
        validated_text = validate_text_style(
            llm=llm,
            text=text,
            config=config,
        )
        print(validated_text)

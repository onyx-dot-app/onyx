{
  "id": "https://github.com/onyx-dot-app/onyx#7",
  "semantic_identifier": "7: feat: Make Zendesk/Intercom conversation ingest idempotent to prevent duplicate evidence",
  "title": null,
  "source": "github",
  "doc_updated_at": "2025-04-15",
  "metadata": {
    "object_type": "PullRequest",
    "id": "7",
    "merged": "False",
    "state": "open",
    "user": {
      "login": "michael_anderson",
      "name": "michael_anderson",
      "email": "michael_anderson@netherite-extraction.onyx.app"
    },
    "assignees": [
      {
        "login": "brooke_spencer",
        "name": "brooke_spencer",
        "email": "brooke_spencer@netherite-extraction.onyx.app"
      }
    ],
    "repo": "netherite-ext/gold",
    "num_commits": "8",
    "num_files_changed": "37",
    "labels": [],
    "created_at": "2025-04-15",
    "updated_at": "2025-04-15",
    "closed_at": ""
  },
  "doc_metadata": {
    "repo": "netherite-ext/gold",
    "hierarchy": {
      "source_path": [
        "netherite-ext",
        "gold",
        "pull_requests"
      ],
      "owner": "netherite-ext",
      "repo": "gold",
      "object_type": "pull_request"
    }
  },
  "sections": [
    {
      "text": "## Description\r\n\r\nThis PR fixes occasional duplicate conversation/message records created by Zendesk/Intercom read-only ingest when sync jobs are retried or overlapping time windows are fetched.\n\nImplementation:\n- Introduces stable idempotency keys for ingest:\n  - Conversation key: `<source>:conversation:<external_conversation_id>`\n  - Message key: `<source>:message:<external_message_id>` (or `<source>:message:<conversation_id>:<message_id>` when needed)\n- Converts ingest writes to upserts:\n  - Conversations: upsert by conversation idempotency key, updating mutable fields (timestamps, status, metadata) without creating new rows.\n  - Messages/evidence: upsert by message idempotency key; evidence attachment uses a unique constraint to prevent re-attaching the same evidence to multiple issues due to duplicate messages.\n- Adds DB-level uniqueness (unique indexes/constraints) on idempotency keys to enforce dedupe under concurrency.\n- Moves dedupe to occur before clustering/theme assignment so impacted-customer counts and themes remain stable across repeated sync runs.\n- Adds/updates tests covering retry/overlapping-window scenarios to ensure repeated syncs do not change record counts or duplicate issue evidence.\n\nUser impact:\n- No API/UI changes. Sync retries and backfills are now safe and should not inflate conversation counts or attach duplicate evidence.\r\n\r\n## How Has This Been Tested?\r\n\r\nlocal\r\n",
      "link": "https://github.com/onyx-dot-app/onyx#7"
    }
  ],
  "primary_owners": [],
  "secondary_owners": []
}
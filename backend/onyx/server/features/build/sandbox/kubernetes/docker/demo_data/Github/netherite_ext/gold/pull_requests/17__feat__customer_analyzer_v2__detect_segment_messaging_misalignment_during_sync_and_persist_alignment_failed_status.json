{
  "id": "https://github.com/onyx-dot-app/onyx#17",
  "semantic_identifier": "17: feat: Customer_Analyzer v2: Detect segment/messaging misalignment during sync and persist alignment_failed status",
  "title": null,
  "source": "github",
  "doc_updated_at": "2025-12-10",
  "metadata": {
    "object_type": "PullRequest",
    "id": "17",
    "merged": "True",
    "state": "closed",
    "user": {
      "login": "michael_anderson",
      "name": "michael_anderson",
      "email": "michael_anderson@netherite-extraction.onyx.app"
    },
    "assignees": [
      {
        "login": "brooke_spencer",
        "name": "brooke_spencer",
        "email": "brooke_spencer@netherite-extraction.onyx.app"
      }
    ],
    "repo": "netherite-ext/gold",
    "num_commits": "9",
    "num_files_changed": "61",
    "labels": [],
    "created_at": "2025-12-10",
    "updated_at": "2025-12-10",
    "closed_at": "2026-01-03"
  },
  "doc_metadata": {
    "repo": "netherite-ext/gold",
    "hierarchy": {
      "source_path": [
        "netherite-ext",
        "gold",
        "pull_requests"
      ],
      "owner": "netherite-ext",
      "repo": "gold",
      "object_type": "pull_request"
    }
  },
  "sections": [
    {
      "text": "## Description\r\n\r\n### Summary\nAdds a backend-only alignment check to the Sales_Accelerator \u2192 Customer_Analyzer v2 sync. During sync, we now validate that the account/opportunity\u2019s `segment_definition_id` and `messaging_version` match the currently active/expected values. If either value is out of date, the synced record is marked as misaligned and a non-blocking warning is emitted to integration logs.\n\n### Implementation details\n- **Alignment evaluation**\n  - On sync payload preparation/processing, fetch/derive the **expected** `segment_definition_id` and **expected** `messaging_version` for the target entity (using the existing \u201cactive/expected\u201d source of truth used by CA v2).\n  - Compare expected values with those present on the account/opportunity being synced.\n- **Persistence**\n  - If a mismatch is detected, persist `alignment_status = \"alignment_failed\"` on the Customer_Analyzer v2 sync record (or equivalent persisted sync state).\n  - Store enough context to support follow-up/debugging (e.g., expected vs actual IDs/versions where the schema supports it; otherwise rely on logs).\n- **Logging (non-blocking)**\n  - Emit a warning-level integration log entry when alignment fails, including record identifiers and the mismatching fields.\n  - Sync continues without failing the job.\n\n### What changes for users\n- No UI behavior changes in this PR.\n- Misaligned records will appear with `alignment_failed` in persisted sync state and will generate warnings in integration logs for follow-up.\n\n### Notes / non-goals\n- Does **not** block sync, gate UI, or enforce \u201capproved messaging only\u201d drafts\u2014those are explicitly deferred to subsequent tickets.\r\n\r\n## How Has This Been Tested?\r\n\r\nlocal\r\n",
      "link": "https://github.com/onyx-dot-app/onyx#17"
    }
  ],
  "primary_owners": [],
  "secondary_owners": []
}
{
  "id": "https://github.com/onyx-dot-app/onyx#123",
  "semantic_identifier": "123: feat: Add attribution query API for outcome metrics grouped by positioning_version_id",
  "title": null,
  "source": "github",
  "doc_updated_at": "2025-12-31",
  "metadata": {
    "object_type": "PullRequest",
    "id": "123",
    "merged": "False",
    "state": "open",
    "user": {
      "login": "michael_anderson",
      "name": "michael_anderson",
      "email": "michael_anderson@netherite-extraction.onyx.app"
    },
    "assignees": [
      {
        "login": "ryan_murphy",
        "name": "ryan_murphy",
        "email": "ryan_murphy@netherite-extraction.onyx.app"
      }
    ],
    "repo": "netherite-ext/gold",
    "num_commits": "4",
    "num_files_changed": "60",
    "labels": [],
    "created_at": "2025-12-31",
    "updated_at": "2025-12-31",
    "closed_at": ""
  },
  "doc_metadata": {
    "repo": "netherite-ext/gold",
    "hierarchy": {
      "source_path": [
        "netherite-ext",
        "gold",
        "pull_requests"
      ],
      "owner": "netherite-ext",
      "repo": "gold",
      "object_type": "pull_request"
    }
  },
  "sections": [
    {
      "text": "## Description\r\n\r\n## Summary\nImplements a backend attribution endpoint that aggregates outcome metrics (conversion, win/loss, churn) grouped by `positioning_version_id`, using the persisted join key introduced in GOLD-52. The endpoint supports optional filtering and stable, paginated results suitable for an attribution/reporting UI, including side-by-side comparison of two positioning versions over the same time window.\n\n## API\n- **Route**: `GET /api/attribution/outcomes`\n- **Query params**:\n  - `start` / `end` (required): ISO timestamps defining the reporting window\n  - `segmentId` / `icpId` (optional)\n  - `channel` (optional)\n  - `artifactType` (optional)\n  - `positioningVersionId` (optional; if omitted returns all)\n  - `compareToPositioningVersionId` (optional; enables comparison mode)\n  - Pagination: `cursor` (opaque), `limit` (default 50, max 200)\n- **Response** (stable ordering):\n  - `data`: rows keyed by `positioning_version_id` with counts and computed rates\n    - counts: `conversions`, `wins`, `losses`, `churns`, `total`\n    - rates: `conversionRate`, `winRate`, `churnRate` (computed from counts with safe zero handling)\n  - `comparison` (only when `compareToPositioningVersionId` is provided): same shape for the compare version, plus per-metric deltas\n  - `pageInfo`: `nextCursor`, `hasNextPage`\n\n## Implementation details\n- Adds an aggregation query that groups by `positioning_version_id` and applies optional WHERE clauses for segment/ICP, channel, artifact type, and the provided time window.\n- Comparison mode runs the same aggregation for both versions over the identical filters/window and returns aligned results.\n- Ensures deterministic pagination by ordering on `(positioning_version_id, id)` (or equivalent stable tie-breaker) and returning an opaque cursor derived from the last row.\n\n## Performance / indexing\n- Adds/updates DB indexes to support common filter combinations:\n  - composite index on `(positioning_version_id, occurred_at)`\n  - supporting indexes for `segment_id/icp_id`, `channel`, `artifact_type` as used by the query planner\n- Query uses only indexed predicates for window + join key, and returns aggregated results only (no large row scans returned to the client).\n\n## Notes for reviewers\n- Focus on correctness of rate calculations, cursor pagination stability, and query plan (index usage) for typical UI filter combinations.\n- This is a reporting API (medium priority): minimal surface area, no UI changes included.\r\n\r\n## How Has This Been Tested?\r\n\r\nlocal\r\n",
      "link": "https://github.com/onyx-dot-app/onyx#123"
    }
  ],
  "primary_owners": [],
  "secondary_owners": []
}
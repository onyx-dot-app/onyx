{
  "id": "https://github.com/onyx-dot-app/onyx#86",
  "semantic_identifier": "86: feat: Use canonical stage_entered_at for sales_forecast stage aging (deterministic fallback + regression tests)",
  "title": null,
  "source": "github",
  "doc_updated_at": "2025-04-10",
  "metadata": {
    "object_type": "PullRequest",
    "id": "86",
    "merged": "True",
    "state": "closed",
    "user": {
      "login": "michael_anderson",
      "name": "michael_anderson",
      "email": "michael_anderson@netherite-extraction.onyx.app"
    },
    "assignees": [
      {
        "login": "jiwon_kang",
        "name": "jiwon_kang",
        "email": "jiwon_kang@netherite-extraction.onyx.app"
      }
    ],
    "repo": "netherite-ext/gold",
    "num_commits": "1",
    "num_files_changed": "35",
    "labels": [],
    "created_at": "2025-04-10",
    "updated_at": "2025-04-10",
    "closed_at": "2025-04-27"
  },
  "doc_metadata": {
    "repo": "netherite-ext/gold",
    "hierarchy": {
      "source_path": [
        "netherite-ext",
        "gold",
        "pull_requests"
      ],
      "owner": "netherite-ext",
      "repo": "gold",
      "object_type": "pull_request"
    }
  },
  "sections": [
    {
      "text": "## Description\r\n\r\n### Summary\nThis PR updates sales_forecast stage aging to compute time-in-stage from the imported canonical `stage_entered_at` transition timestamps instead of inferring from opportunity `created_at`/`updated_at`.\n\n### What changed\n- Updated the stage aging service/query logic to source the current stage\u2019s \u201centered at\u201d timestamp from canonical transition data.\n- Ensures we deterministically select the most recent transition timestamp for the opportunity\u2019s *current* stage (e.g., `MAX(stage_entered_at)` scoped to the current stage).\n- Introduced a clear, single fallback path when canonical `stage_entered_at` is missing:\n  - Use the opportunity\u2019s `updated_at` if it reflects a stage change timestamp (when available in existing data shape), otherwise fall back to `created_at` as a last resort.\n- Kept output schema stable so downstream consumers don\u2019t need changes.\n\n### Downstream impact\n- Sales forecast rollups and historical conversion benchmarks now consume the corrected stage aging output, improving accuracy when opportunities have multiple stage transitions or non-stage updates.\n\n### Tests\n- Added lightweight regression coverage to validate:\n  - The latest transition timestamp is used when multiple entries exist for the same stage.\n  - The fallback behavior is applied only when canonical `stage_entered_at` is absent.\n  - Rollup/benchmark queries consume the corrected stage aging values.\n\n### Notes\n- Priority is low; changes are scoped to stage aging derivation and regression tests, with no intended behavior changes beyond fixing time-in-stage accuracy.\r\n\r\n## How Has This Been Tested?\r\n\r\nstaging\r\n",
      "link": "https://github.com/onyx-dot-app/onyx#86"
    }
  ],
  "primary_owners": [],
  "secondary_owners": []
}
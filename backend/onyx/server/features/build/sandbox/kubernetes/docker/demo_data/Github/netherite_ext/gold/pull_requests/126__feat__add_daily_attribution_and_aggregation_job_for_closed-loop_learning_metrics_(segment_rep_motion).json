{
  "id": "https://github.com/onyx-dot-app/onyx#126",
  "semantic_identifier": "126: feat: Add daily attribution + aggregation job for closed-loop learning metrics (segment/rep/motion)",
  "title": null,
  "source": "github",
  "doc_updated_at": "2025-12-19",
  "metadata": {
    "object_type": "PullRequest",
    "id": "126",
    "merged": "False",
    "state": "open",
    "user": {
      "login": "kenji_watanabe",
      "name": "kenji_watanabe",
      "email": "kenji_watanabe@netherite-extraction.onyx.app"
    },
    "assignees": [
      {
        "login": "tyler_jenkins",
        "name": "tyler_jenkins",
        "email": "tyler_jenkins@netherite-extraction.onyx.app"
      }
    ],
    "repo": "netherite-ext/gold",
    "num_commits": "7",
    "num_files_changed": "77",
    "labels": [],
    "created_at": "2025-12-19",
    "updated_at": "2025-12-19",
    "closed_at": ""
  },
  "doc_metadata": {
    "repo": "netherite-ext/gold",
    "hierarchy": {
      "source_path": [
        "netherite-ext",
        "gold",
        "pull_requests"
      ],
      "owner": "netherite-ext",
      "repo": "gold",
      "object_type": "pull_request"
    }
  },
  "sections": [
    {
      "text": "## Description\r\n\r\n## Summary\nImplements the closed-loop learning metrics pipeline by attributing persisted outcome events back to `recommendation_instance_id` and producing daily aggregated funnel metrics grouped by segment, rep, and motion. Aggregates are stored in a queryable table and exposed via a lightweight read API for downstream optimization.\n\n## What this PR adds\n- **Attribution join job** that links outcome events (from GOLD-108) to `recommendation_instance_id` and enriches with:\n  - segment identifier\n  - rep identifier\n  - motion/type\n  - event timestamps and normalized event types\n- **Daily aggregation** (by `day \u00d7 segment \u00d7 rep \u00d7 motion`) producing counts and rates for:\n  - show \u2192 accept\n  - accept \u2192 execute\n  - execute \u2192 meeting\n  - stage change\n  - win / loss\n  - plus supporting denominators (e.g., total shown, total accepted, etc.)\n- **Storage**\n  - New table (partitioned by `day`) for aggregates with idempotent upsert keyed by `(day, segment_id, rep_id, motion)`.\n  - Schema includes raw counts, derived rates, and metadata (job run id, watermark, late-event counters).\n- **Read access**\n  - Simple internal API/query helper to fetch aggregates for a date range and optional filters (segment/rep/motion).\n\n## Implementation details\n- **Batch job/service**\n  - Runs on a daily schedule with a configurable lookback window (default: last N days) to handle late-arriving events.\n  - Uses a watermark on event time and an idempotent recompute strategy for the lookback range to avoid double-counting.\n- **Resilience to partial lifecycles**\n  - Aggregation is event-driven and does not assume complete funnels; metrics are computed from available events per instance.\n  - Missing intermediate steps do not block counting later events; denominators are computed per step.\n- **Data-quality checks (logged + surfaced in metadata)**\n  - Missing/invalid `recommendation_instance_id` on outcome events\n  - Duplicate outcome events per `(instance_id, event_type, event_time)` beyond tolerance\n  - Events outside expected time bounds (very late/early)\n  - Row-level mismatch between attribution join inputs vs outputs\n- **Backfill support**\n  - CLI/entrypoint supports `--start-date/--end-date` to recompute recent history.\n  - Backfill uses the same idempotent upsert logic as scheduled runs.\n- **Serving safety**\n  - Runs entirely out-of-band from recommendation serving paths.\n  - All reads are on persisted event/instance tables; no synchronous calls in serving.\n\n## Operational notes\n- Default schedule and lookback are conservative (low priority rollout): metrics are computed for recent history only unless backfilled.\n- No user-facing product changes; this is backend-only plumbing for analytics/optimization.\r\n\r\n## How Has This Been Tested?\r\n\r\nstaging\r\n",
      "link": "https://github.com/onyx-dot-app/onyx#126"
    }
  ],
  "primary_owners": [],
  "secondary_owners": []
}
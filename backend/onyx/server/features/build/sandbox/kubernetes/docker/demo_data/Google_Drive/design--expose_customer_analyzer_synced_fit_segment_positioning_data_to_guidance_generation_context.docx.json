{
  "id": "7d31d1bf8b52430c8f5ba145ba5698f0",
  "semantic_identifier": "Design--Expose Customer_Analyzer synced fit/segment/positioning data to guidance generation context.docx",
  "title": null,
  "source": "google_doc",
  "doc_updated_at": "2025-06-07",
  "metadata": {
    "owner_names": ""
  },
  "doc_metadata": {
    "hierarchy": {
      "source_path": [
        "My Drive"
      ],
      "drive_id": null,
      "file_name": "Design--Expose Customer_Analyzer synced fit/segment/positioning data to guidance generation context.docx",
      "mime_type": "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
    }
  },
  "sections": [
    {
      "text": "This feature adds a retrieval layer that makes Customer_Analyzer\u2019s synced \u201cfit/segment/positioning\u201d signals available as structured context to both the initiation and follow\u2011up guidance generators for a given CRM entity. The scope is strictly data access + wiring: we will not change prompt templates, ranking, or copy generation logic; we will only enrich the generator\u2019s input context with optional fields sourced from the Customer_Analyzer integration table.\n\nWe will introduce a service method (and, if needed, a thin internal API) that accepts a CRM identifier and type (Account or Opportunity) and returns a canonical `CustomerAnalyzerContext` object: `{ fitScore, segment, positioningBlocks[], syncedAt, sourceVersion }`. The retrieval implementation will resolve correct ID mapping: for Opportunities, we\u2019ll fetch by opportunity ID when available and fall back to its parent account mapping only if the integration data is keyed that way; for Accounts, we\u2019ll fetch directly by account ID. To ensure deterministic results, selection will always choose the latest synced record by a stable ordering (e.g., `synced_at DESC`, then `integration_row_id DESC` as a tiebreaker) and will only surface \u201capproved\u201d positioning blocks per the integration schema.\n\nTo control latency and load, we\u2019ll add caching keyed by `(crmType, crmId)` with a short TTL (e.g., minutes) and explicit cache busting on known sync events if we have a webhook/ingestion pipeline signal. The service will validate staleness via `syncedAt` against a configured maximum age; if the data is missing, unmapped, or stale, it will return an empty context with metadata indicating the reason (e.g., `status: MISSING|STALE|OK`) so callers can safely proceed without hard failures.\n\nFinally, we will wire this retrieval into the guidance generation pipeline at the context-building step for both initiation and follow-up flows. The generator will treat the returned fields as optional additions to its existing context object, preserving current behavior when absent. We\u2019ll add basic observability (counters for hit/miss/stale, latency, mapping failures) and lightweight integration tests covering account vs opportunity mapping, latest-record determinism, and fallback behavior.",
      "link": "https://www.onyx.app/58362"
    }
  ],
  "primary_owners": [
    "kevin_sullivan"
  ],
  "secondary_owners": []
}
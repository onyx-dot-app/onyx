#!/usr/bin/env python3
"""Build sandbox templates for Next.js app and Python venv."""

import argparse
import json
import subprocess
import sys
from pathlib import Path
from typing import Any

try:
    from onyx.server.features.build.configs import (
        OUTPUTS_TEMPLATE_PATH,
        VENV_TEMPLATE_PATH,
    )
except ImportError:
    # Fallback if running as standalone script
    import os

    OUTPUTS_TEMPLATE_PATH = os.environ.get(
        "OUTPUTS_TEMPLATE_PATH", "/templates/outputs"
    )
    VENV_TEMPLATE_PATH = os.environ.get("VENV_TEMPLATE_PATH", "/templates/venv")


def build_nextjs_template(output_path: Path) -> None:
    """Build Next.js app template.

    Creates a minimal Next.js 16.1.1 app with React 19, Tailwindcss, and recharts.

    Args:
        output_path: Path where the outputs template should be created (will create web/ subdirectory)
    """
    web_dir = output_path / "web"
    web_dir.mkdir(parents=True, exist_ok=True)

    # package.json
    package_json: dict[str, Any] = {
        "name": "onyx-sandbox-app",
        "version": "0.1.0",
        "private": True,
        "scripts": {
            "dev": "next dev",
            "build": "next build",
            "start": "next start",
            "lint": "next lint",
        },
        "dependencies": {
            "next": "16.1.1",
            "react": "^19.0.0",
            "react-dom": "^19.0.0",
            "recharts": "^2.12.0",
        },
        "devDependencies": {
            "@types/node": "^20",
            "@types/react": "^19",
            "@types/react-dom": "^19",
            "autoprefixer": "^10.4.20",
            "postcss": "^8.4.47",
            "tailwindcss": "^3.4.1",
            "typescript": "^5",
        },
    }
    (web_dir / "package.json").write_text(json.dumps(package_json, indent=2))

    # next.config.js
    next_config = """/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
}

module.exports = nextConfig
"""
    (web_dir / "next.config.js").write_text(next_config)

    # tailwind.config.js
    tailwind_config = """/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
    './src/components/**/*.{js,ts,jsx,tsx,mdx}',
    './src/app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
"""
    (web_dir / "tailwind.config.js").write_text(tailwind_config)

    # postcss.config.js
    postcss_config = """module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
"""
    (web_dir / "postcss.config.js").write_text(postcss_config)

    # tsconfig.json
    tsconfig: dict[str, Any] = {
        "compilerOptions": {
            "target": "ES2020",
            "lib": ["dom", "dom.iterable", "esnext"],
            "allowJs": True,
            "skipLibCheck": True,
            "strict": True,
            "noEmit": True,
            "esModuleInterop": True,
            "module": "esnext",
            "moduleResolution": "bundler",
            "resolveJsonModule": True,
            "isolatedModules": True,
            "jsx": "preserve",
            "incremental": True,
            "plugins": [{"name": "next"}],
            "paths": {"@/*": ["./src/*"]},
        },
        "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
        "exclude": ["node_modules"],
    }
    (web_dir / "tsconfig.json").write_text(json.dumps(tsconfig, indent=2))

    # src/app/layout.tsx
    layout_tsx = """export const metadata = {
  title: 'Onyx Sandbox App',
  description: 'Generated by Onyx',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
      <body>{children}</body>
    </html>
  )
}
"""
    (web_dir / "src" / "app").mkdir(parents=True, exist_ok=True)
    (web_dir / "src" / "app" / "layout.tsx").write_text(layout_tsx)

    # src/app/page.tsx
    page_tsx = """export default function Home() {
  return (
    <main>
      <h1>Onyx Sandbox App</h1>
      <p>Welcome to your generated Next.js app</p>
    </main>
  )
}
"""
    (web_dir / "src" / "app" / "page.tsx").write_text(page_tsx)

    # src/app/globals.css
    globals_css = """@tailwind base;
@tailwind components;
@tailwind utilities;
"""
    (web_dir / "src" / "app" / "globals.css").write_text(globals_css)

    # public directory
    (web_dir / "public").mkdir(exist_ok=True)

    # Install npm dependencies
    print("  Installing npm dependencies...")
    install_result = subprocess.run(
        ["npm", "install"],
        cwd=web_dir,
        capture_output=True,
        text=True,
    )
    if install_result.returncode != 0:
        raise RuntimeError(
            f"Failed to install npm dependencies: {install_result.stderr}"
        )


def build_python_venv_template(target_path: Path, requirements_path: Path) -> None:
    """Build Python venv template with required packages.

    Creates a Python virtual environment and installs packages from requirements file.

    Args:
        target_path: Path where the venv should be created
        requirements_path: Path to requirements.txt file

    Raises:
        RuntimeError: If venv creation or package installation fails
    """
    if not requirements_path.exists():
        raise FileNotFoundError(f"Requirements file not found: {requirements_path}")

    # Create venv
    print("  Creating virtual environment...")
    result = subprocess.run(
        [sys.executable, "-m", "venv", str(target_path)],
        capture_output=True,
        text=True,
    )
    if result.returncode != 0:
        raise RuntimeError(f"Failed to create virtual environment: {result.stderr}")

    # Determine pip path based on OS
    if sys.platform == "win32":
        pip_path = target_path / "Scripts" / "pip"
    else:
        pip_path = target_path / "bin" / "pip"

    # Install requirements
    print(f"  Installing packages from {requirements_path.name}...")
    install_result = subprocess.run(
        [str(pip_path), "install", "-r", str(requirements_path)],
        capture_output=True,
        text=True,
    )
    if install_result.returncode != 0:
        raise RuntimeError(f"Failed to install packages: {install_result.stderr}")


def main() -> None:
    """Build both templates."""
    parser = argparse.ArgumentParser(
        description="Build sandbox templates for Next.js app and Python venv"
    )
    parser.add_argument(
        "--outputs-dir",
        type=str,
        default=OUTPUTS_TEMPLATE_PATH,
        help=f"Output directory for Next.js template (default: {OUTPUTS_TEMPLATE_PATH})",
    )
    parser.add_argument(
        "--venv-dir",
        type=str,
        default=VENV_TEMPLATE_PATH,
        help=f"Output directory for Python venv template (default: {VENV_TEMPLATE_PATH})",
    )
    parser.add_argument(
        "--requirements",
        type=str,
        default=None,
        help="Path to requirements.txt (default: auto-detect)",
    )

    args = parser.parse_args()

    outputs_dir = Path(args.outputs_dir)
    venv_dir = Path(args.venv_dir)

    # Find requirements file
    if args.requirements:
        requirements_file = Path(args.requirements)
    else:
        # Try to find requirements file relative to script location
        script_dir = Path(__file__).parent
        requirements_file = script_dir.parent / "initial-requirements.txt"
        if not requirements_file.exists():
            raise FileNotFoundError(
                "Could not find requirements file. "
                f"Expected at {requirements_file} or specify with --requirements"
            )

    # Build Next.js template
    print(f"Building Next.js template to {outputs_dir}...")
    build_nextjs_template(outputs_dir)
    print("✅ Next.js template built successfully")

    # Build Python venv template
    print(f"\nBuilding Python venv template to {venv_dir}...")
    print("  (This may take 30-60 seconds)")
    build_python_venv_template(venv_dir, requirements_file)
    print("✅ Python venv template built successfully")

    print("\nTemplates ready!")


if __name__ == "__main__":
    main()

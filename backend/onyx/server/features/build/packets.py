"""Build Mode packet types for streaming agent responses.

This module defines CUSTOM Onyx packet types that extend ACP (Agent Client Protocol).
ACP events are passed through directly from the agent - this module only contains
Onyx-specific extensions like artifacts and file operations.

All packets use SSE (Server-Sent Events) format with `event: message` and include
a `type` field to distinguish packet types.

ACP events (passed through directly from acp.schema):
- agent_message_chunk: Text/image content from agent
- agent_thought_chunk: Agent's internal reasoning
- tool_call_start: Tool invocation started
- tool_call_progress: Tool execution progress/result
- agent_plan_update: Agent's execution plan
- current_mode_update: Agent mode change
- prompt_response: Agent finished processing
- error: An error occurred

Custom Onyx packets (defined here):
- artifact_created: New artifact generated
- file_write: File written to sandbox
- error: Onyx-specific errors (e.g., session not found)

Based on:
- Agent Client Protocol (ACP): https://agentclientprotocol.com
"""

from datetime import datetime
from datetime import timezone
from enum import Enum
from typing import Any
from typing import Literal
from uuid import UUID

from pydantic import BaseModel
from pydantic import Field


# =============================================================================
# Base Packet Type
# =============================================================================


class BasePacket(BaseModel):
    """Base packet with common fields for all custom Onyx packet types."""

    type: str
    timestamp: str = Field(
        default_factory=lambda: datetime.now(tz=timezone.utc).isoformat()
    )


# =============================================================================
# Custom Onyx Packets
# =============================================================================


class ErrorPacket(BasePacket):
    """An Onyx-specific error occurred (e.g., session not found, sandbox not running)."""

    type: Literal["error"] = "error"
    message: str
    code: int | None = None
    details: dict[str, Any] | None = None


class FileWritePacket(BasePacket):
    """File written to sandbox."""

    type: Literal["file_write"] = "file_write"
    path: str
    size_bytes: int | None = None
    operation: Literal["create", "update", "delete"] = "create"


class ArtifactType(str, Enum):
    """Type of artifact generated."""

    WEB_APP = "web_app"
    MARKDOWN = "markdown"
    IMAGE = "image"
    CSV = "csv"
    EXCEL = "excel"
    PPTX = "pptx"
    DOCX = "docx"
    PDF = "pdf"
    CODE = "code"
    OTHER = "other"


class Artifact(BaseModel):
    """An artifact generated by the agent."""

    id: str  # UUID
    type: ArtifactType
    name: str
    path: str  # Relative path from sandbox root
    preview_url: str | None = None
    download_url: str | None = None
    mime_type: str | None = None
    size_bytes: int | None = None
    metadata: dict[str, Any] | None = None


class ArtifactCreatedPacket(BasePacket):
    """New artifact generated."""

    type: Literal["artifact_created"] = "artifact_created"
    artifact: Artifact


# =============================================================================
# Union Type for Custom Onyx Packets
# =============================================================================

BuildPacket = ErrorPacket | FileWritePacket | ArtifactCreatedPacket


# =============================================================================
# Helper Functions
# =============================================================================


def create_artifact_from_file(
    session_id: UUID,
    file_path: str,
    artifact_type: ArtifactType,
    name: str,
    mime_type: str | None = None,
) -> Artifact:
    """Create an Artifact from a file path."""
    import uuid

    artifact_id = str(uuid.uuid4())

    # Build preview URL based on artifact type
    if artifact_type == ArtifactType.WEB_APP:
        preview_url = f"/api/build/sessions/{session_id}/preview"
    elif artifact_type in [
        ArtifactType.IMAGE,
        ArtifactType.PPTX,
        ArtifactType.EXCEL,
        ArtifactType.DOCX,
    ]:
        preview_url = f"/api/build/sessions/{session_id}/artifacts/{file_path}"
    else:
        preview_url = None

    return Artifact(
        id=artifact_id,
        type=artifact_type,
        name=name,
        path=file_path,
        preview_url=preview_url,
        download_url=f"/api/build/sessions/{session_id}/artifacts/{file_path}",
        mime_type=mime_type,
    )

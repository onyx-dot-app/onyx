"""agent to agent

Revision ID: 0565863f36eb
Revises: e8f0d2a38171
Create Date: 2025-12-05 10:20:03.272558

"""

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = "0565863f36eb"
down_revision = "e8f0d2a38171"
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "available_tenant",
        sa.Column("tenant_id", sa.String(), nullable=False),
        sa.Column("alembic_version", sa.String(), nullable=False),
        sa.Column("date_created", sa.DateTime(), nullable=False),
        sa.PrimaryKeyConstraint("tenant_id"),
    )
    op.create_table(
        "user_tenant_mapping",
        sa.Column("email", sa.String(), nullable=False),
        sa.Column("tenant_id", sa.String(), nullable=False),
        sa.Column("active", sa.Boolean(), nullable=False),
        sa.PrimaryKeyConstraint("email", "tenant_id"),
        schema="public",
    )
    op.create_table(
        "tenant_anonymous_user_path",
        sa.Column("tenant_id", sa.String(), nullable=False),
        sa.Column("anonymous_user_path", sa.String(), nullable=False),
        sa.PrimaryKeyConstraint("tenant_id"),
        sa.UniqueConstraint("anonymous_user_path"),
    )
    op.create_table(
        "persona__persona",
        sa.Column("parent_persona_id", sa.Integer(), nullable=False),
        sa.Column("child_persona_id", sa.Integer(), nullable=False),
        sa.Column("pass_conversation_context", sa.Boolean(), nullable=False),
        sa.Column("pass_files", sa.Boolean(), nullable=False),
        sa.Column("max_tokens_to_child", sa.Integer(), nullable=True),
        sa.Column("max_tokens_from_child", sa.Integer(), nullable=True),
        sa.Column("invocation_instructions", sa.Text(), nullable=True),
        sa.ForeignKeyConstraint(
            ["child_persona_id"], ["persona.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["parent_persona_id"], ["persona.id"], ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("parent_persona_id", "child_persona_id"),
    )
    op.create_table(
        "celery_taskmeta",
        sa.Column("id", sa.Integer(), autoincrement=True, nullable=False),
        sa.Column("task_id", sa.String(length=155), nullable=True),
        sa.Column("status", sa.String(length=50), nullable=True),
        sa.Column("result", sa.PickleType(), nullable=True),
        sa.Column("date_done", sa.DateTime(), nullable=True),
        sa.Column("traceback", sa.Text(), nullable=True),
        sa.Column("name", sa.String(length=155), nullable=True),
        sa.Column("args", sa.LargeBinary(), nullable=True),
        sa.Column("kwargs", sa.LargeBinary(), nullable=True),
        sa.Column("worker", sa.String(length=155), nullable=True),
        sa.Column("retries", sa.Integer(), nullable=True),
        sa.Column("queue", sa.String(length=155), nullable=True),
        sa.PrimaryKeyConstraint("id"),
        sa.UniqueConstraint("task_id"),
        sqlite_autoincrement=True,
    )
    op.create_table(
        "celery_tasksetmeta",
        sa.Column("id", sa.Integer(), autoincrement=True, nullable=False),
        sa.Column("taskset_id", sa.String(length=155), nullable=True),
        sa.Column("result", sa.PickleType(), nullable=True),
        sa.Column("date_done", sa.DateTime(), nullable=True),
        sa.PrimaryKeyConstraint("id"),
        sa.UniqueConstraint("taskset_id"),
        sqlite_autoincrement=True,
    )
    op.drop_table("alembic_version")
    op.create_foreign_key(None, "api_key", "user", ["user_id"], ["id"])
    op.create_foreign_key(None, "api_key", "user", ["owner_id"], ["id"])
    op.alter_column(
        "chat_message",
        "chat_session_id",
        existing_type=sa.UUID(),
        nullable=False,
    )
    op.alter_column(
        "chat_message",
        "message_type",
        existing_type=sa.VARCHAR(length=9),
        type_=sa.Enum(
            "SYSTEM",
            "USER",
            "ASSISTANT",
            "TOOL_CALL",
            "TOOL_CALL_RESPONSE",
            name="messagetype",
            native_enum=False,
        ),
        existing_nullable=False,
    )
    op.drop_constraint("chat_message_id_key", "chat_message", type_="unique")
    op.drop_index("idx_chat_message_tsv", table_name="chat_message")
    op.drop_constraint(
        "chat_message_chat_session_id_fkey", "chat_message", type_="foreignkey"
    )
    op.create_foreign_key(
        None, "chat_message", "chat_session", ["chat_session_id"], ["id"]
    )
    op.drop_column("chat_message", "message_tsv")
    op.alter_column(
        "chat_session",
        "id",
        existing_type=sa.UUID(),
        server_default=None,
        existing_nullable=False,
    )
    op.drop_index("idx_chat_session_desc_tsv", table_name="chat_session")
    op.drop_index("ix_chat_session_project_id", table_name="chat_session")
    op.drop_column("chat_session", "description_tsv")
    op.alter_column(
        "chunk_stats",
        "last_modified",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "connector",
        "source",
        existing_type=sa.VARCHAR(length=50),
        type_=sa.Enum(
            "INGESTION_API",
            "SLACK",
            "WEB",
            "GOOGLE_DRIVE",
            "GMAIL",
            "REQUESTTRACKER",
            "GITHUB",
            "GITBOOK",
            "GITLAB",
            "GURU",
            "BOOKSTACK",
            "OUTLINE",
            "CONFLUENCE",
            "JIRA",
            "SLAB",
            "PRODUCTBOARD",
            "FILE",
            "NOTION",
            "ZULIP",
            "LINEAR",
            "HUBSPOT",
            "DOCUMENT360",
            "GONG",
            "GOOGLE_SITES",
            "ZENDESK",
            "LOOPIO",
            "DROPBOX",
            "SHAREPOINT",
            "TEAMS",
            "SALESFORCE",
            "DISCOURSE",
            "AXERO",
            "CLICKUP",
            "MEDIAWIKI",
            "WIKIPEDIA",
            "ASANA",
            "S3",
            "R2",
            "GOOGLE_CLOUD_STORAGE",
            "OCI_STORAGE",
            "XENFORO",
            "NOT_APPLICABLE",
            "DISCORD",
            "FRESHDESK",
            "FIREFLIES",
            "EGNYTE",
            "AIRTABLE",
            "HIGHSPOT",
            "IMAP",
            "BITBUCKET",
            "TESTRAIL",
            "MOCK_CONNECTOR",
            "USER_FILE",
            name="documentsource",
            native_enum=False,
        ),
        existing_nullable=False,
    )
    op.alter_column(
        "connector",
        "input_type",
        existing_type=sa.VARCHAR(length=10),
        type_=sa.Enum(
            "LOAD_STATE",
            "POLL",
            "EVENT",
            "SLIM_RETRIEVAL",
            name="inputtype",
            native_enum=False,
        ),
        existing_nullable=True,
    )
    op.alter_column(
        "connector",
        "kg_processing_enabled",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        nullable=False,
        comment="Whether this connector should extract knowledge graph entities",
    )
    op.alter_column(
        "connector_credential_pair",
        "is_user_file",
        existing_type=sa.BOOLEAN(),
        nullable=False,
    )
    op.alter_column(
        "connector_credential_pair",
        "id",
        existing_type=sa.INTEGER(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "connector_credential_pair",
        "in_repeated_error_state",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        nullable=False,
    )
    op.create_index(
        op.f("ix_connector_credential_pair_last_pruned"),
        "connector_credential_pair",
        ["last_pruned"],
        unique=False,
    )
    op.alter_column(
        "credential",
        "source",
        existing_type=sa.VARCHAR(length=100),
        type_=sa.Enum(
            "INGESTION_API",
            "SLACK",
            "WEB",
            "GOOGLE_DRIVE",
            "GMAIL",
            "REQUESTTRACKER",
            "GITHUB",
            "GITBOOK",
            "GITLAB",
            "GURU",
            "BOOKSTACK",
            "OUTLINE",
            "CONFLUENCE",
            "JIRA",
            "SLAB",
            "PRODUCTBOARD",
            "FILE",
            "NOTION",
            "ZULIP",
            "LINEAR",
            "HUBSPOT",
            "DOCUMENT360",
            "GONG",
            "GOOGLE_SITES",
            "ZENDESK",
            "LOOPIO",
            "DROPBOX",
            "SHAREPOINT",
            "TEAMS",
            "SALESFORCE",
            "DISCOURSE",
            "AXERO",
            "CLICKUP",
            "MEDIAWIKI",
            "WIKIPEDIA",
            "ASANA",
            "S3",
            "R2",
            "GOOGLE_CLOUD_STORAGE",
            "OCI_STORAGE",
            "XENFORO",
            "NOT_APPLICABLE",
            "DISCORD",
            "FRESHDESK",
            "FIREFLIES",
            "EGNYTE",
            "AIRTABLE",
            "HIGHSPOT",
            "IMAP",
            "BITBUCKET",
            "TESTRAIL",
            "MOCK_CONNECTOR",
            "USER_FILE",
            name="documentsource",
            native_enum=False,
        ),
        nullable=False,
    )
    op.alter_column(
        "credential",
        "credential_json",
        existing_type=postgresql.BYTEA(),
        nullable=False,
    )
    op.alter_column(
        "credential",
        "curator_public",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "document",
        "last_modified",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column("document", "is_public", existing_type=sa.BOOLEAN(), nullable=False)
    op.alter_column(
        "document",
        "kg_stage",
        existing_type=sa.VARCHAR(),
        nullable=False,
        comment="Status of knowledge graph extraction for this document",
    )
    op.drop_index(
        "ix_document_by_connector_credential_pair_pkey__connecto_27dc",
        table_name="document_by_connector_credential_pair",
    )
    op.drop_constraint("document_set_user_id_fkey", "document_set", type_="foreignkey")
    op.create_foreign_key(
        None, "document_set", "user", ["user_id"], ["id"], ondelete="CASCADE"
    )
    op.alter_column(
        "document_set__user", "user_id", existing_type=sa.UUID(), nullable=True
    )
    op.drop_constraint(
        "document_set__user_user_id_fkey",
        "document_set__user",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "document_set__user",
        "user",
        ["user_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.alter_column(
        "embedding_provider",
        "provider_type",
        existing_type=sa.VARCHAR(length=50),
        type_=sa.Enum(
            "OPENAI",
            "COHERE",
            "VOYAGE",
            "GOOGLE",
            "LITELLM",
            "AZURE",
            name="embeddingprovider",
        ),
        existing_nullable=False,
    )
    op.alter_column(
        "file_record",
        "file_origin",
        existing_type=sa.VARCHAR(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "file_record",
        "file_type",
        existing_type=sa.VARCHAR(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "file_record",
        "bucket_name",
        existing_type=sa.VARCHAR(),
        nullable=False,
    )
    op.alter_column(
        "file_record", "object_key", existing_type=sa.VARCHAR(), nullable=False
    )
    op.alter_column(
        "index_attempt",
        "error_msg",
        existing_type=sa.VARCHAR(),
        type_=sa.Text(),
        existing_nullable=True,
    )
    op.alter_column(
        "index_attempt",
        "cancellation_requested",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "index_attempt",
        "completed_batches",
        existing_type=sa.INTEGER(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "index_attempt",
        "total_failures_batch_level",
        existing_type=sa.INTEGER(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "index_attempt",
        "total_chunks",
        existing_type=sa.INTEGER(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "index_attempt",
        "last_batches_completed_count",
        existing_type=sa.INTEGER(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "index_attempt",
        "heartbeat_counter",
        existing_type=sa.INTEGER(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "index_attempt",
        "last_heartbeat_value",
        existing_type=sa.INTEGER(),
        server_default=None,
        existing_nullable=False,
    )
    op.drop_index("ix_index_attempt_status", table_name="index_attempt")
    op.drop_constraint("inputprompt_user_id_fkey", "inputprompt", type_="foreignkey")
    op.create_foreign_key(
        None, "inputprompt", "user", ["user_id"], ["id"], ondelete="CASCADE"
    )
    op.alter_column(
        "inputprompt__user",
        "user_id",
        existing_type=sa.UUID(),
        type_=sa.Integer(),
        nullable=True,
    )
    op.drop_constraint(
        "inputprompt__user_user_id_fkey",
        "inputprompt__user",
        type_="foreignkey",
    )
    op.drop_constraint(
        "inputprompt__user_input_prompt_id_fkey",
        "inputprompt__user",
        type_="foreignkey",
    )
    op.create_foreign_key(None, "inputprompt__user", "inputprompt", ["user_id"], ["id"])
    op.create_foreign_key(
        None, "inputprompt__user", "inputprompt", ["input_prompt_id"], ["id"]
    )
    op.alter_column(
        "internet_content_provider",
        "is_active",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.drop_index(
        "ix_internet_content_provider_is_active",
        table_name="internet_content_provider",
    )
    op.alter_column(
        "internet_search_provider",
        "is_active",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.drop_index(
        "ix_internet_search_provider_is_active",
        table_name="internet_search_provider",
    )
    op.alter_column(
        "kg_entity",
        "attributes",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="Attributes for this entity",
        existing_nullable=False,
        existing_server_default=sa.text("'{}'::jsonb"),
    )
    op.alter_column(
        "kg_entity",
        "alternative_names",
        existing_type=postgresql.ARRAY(sa.VARCHAR()),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity",
        "keywords",
        existing_type=postgresql.ARRAY(sa.VARCHAR()),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity",
        "occurrences",
        existing_type=sa.INTEGER(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity",
        "acl",
        existing_type=postgresql.ARRAY(sa.VARCHAR()),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity",
        "boosts",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity",
        "event_time",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Time of the event being processed",
        existing_nullable=True,
    )
    op.alter_column(
        "kg_entity",
        "time_updated",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_entity",
        "time_created",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.drop_index("idx_kg_entity_clustering_trigrams", table_name="kg_entity")
    op.drop_index("idx_kg_entity_normalization_trigrams", table_name="kg_entity")
    op.drop_constraint("uq_kg_entity_name_type_doc", "kg_entity", type_="unique")
    op.drop_constraint("kg_entity_document_id_fkey", "kg_entity", type_="foreignkey")
    op.alter_column(
        "kg_entity_extraction_staging",
        "attributes",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="Attributes for this entity",
        existing_nullable=False,
        existing_server_default=sa.text("'{}'::jsonb"),
    )
    op.alter_column(
        "kg_entity_extraction_staging",
        "alternative_names",
        existing_type=postgresql.ARRAY(sa.VARCHAR()),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity_extraction_staging",
        "keywords",
        existing_type=postgresql.ARRAY(sa.VARCHAR()),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity_extraction_staging",
        "occurrences",
        existing_type=sa.INTEGER(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity_extraction_staging",
        "acl",
        existing_type=postgresql.ARRAY(sa.VARCHAR()),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity_extraction_staging",
        "boosts",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity_extraction_staging",
        "event_time",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Time of the event being processed",
        existing_nullable=True,
    )
    op.alter_column(
        "kg_entity_extraction_staging",
        "time_created",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.drop_index(
        "ix_entity_extraction_staging_acl",
        table_name="kg_entity_extraction_staging",
    )
    op.drop_index(
        "ix_entity_extraction_staging_name_search",
        table_name="kg_entity_extraction_staging",
    )
    op.create_index(
        "ix_entity_name_search",
        "kg_entity_extraction_staging",
        ["name", "entity_type_id_name"],
        unique=False,
    )
    op.create_index(
        "ix_entity_type_acl",
        "kg_entity_extraction_staging",
        ["entity_type_id_name", "acl"],
        unique=False,
    )
    op.drop_constraint(
        "kg_entity_extraction_staging_document_id_fkey",
        "kg_entity_extraction_staging",
        type_="foreignkey",
    )
    op.alter_column(
        "kg_entity_type",
        "attributes",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        nullable=True,
        comment="Filtering based on document attribute",
        existing_server_default=sa.text("'{}'::jsonb"),
    )
    op.alter_column(
        "kg_entity_type",
        "occurrences",
        existing_type=sa.INTEGER(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity_type",
        "time_updated",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_entity_type",
        "time_created",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_entity_type",
        "clustering",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="Clustering information for this entity type",
        existing_nullable=False,
        existing_server_default=sa.text("'{}'::jsonb"),
    )
    op.alter_column(
        "kg_relationship",
        "source_document",
        existing_type=sa.VARCHAR(),
        nullable=True,
    )
    op.alter_column(
        "kg_relationship",
        "occurrences",
        existing_type=sa.INTEGER(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "kg_relationship",
        "time_updated",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_relationship",
        "time_created",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_relationship_extraction_staging",
        "source_document",
        existing_type=sa.VARCHAR(),
        nullable=True,
    )
    op.alter_column(
        "kg_relationship_extraction_staging",
        "occurrences",
        existing_type=sa.INTEGER(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "kg_relationship_extraction_staging",
        "transferred",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "kg_relationship_extraction_staging",
        "time_created",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.drop_index(
        "ix_kg_relationship_extraction_staging_nodes",
        table_name="kg_relationship_extraction_staging",
    )
    op.drop_constraint(
        "uq_kg_relationship_extraction_staging_source_target_type",
        "kg_relationship_extraction_staging",
        type_="unique",
    )
    op.create_index(
        "ix_kg_relationship_nodes",
        "kg_relationship_extraction_staging",
        ["source_node", "target_node"],
        unique=False,
    )
    op.create_index(
        "ix_kg_relationship_type",
        "kg_relationship_extraction_staging",
        ["type"],
        unique=False,
    )
    op.create_unique_constraint(
        "uq_kg_relationship_source_target_type",
        "kg_relationship_extraction_staging",
        ["source_node", "target_node", "type"],
    )
    op.alter_column(
        "kg_relationship_type",
        "definition",
        existing_type=sa.BOOLEAN(),
        comment="Whether this relationship type represents a definition",
        existing_nullable=False,
    )
    op.alter_column(
        "kg_relationship_type",
        "clustering",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="Clustering information for this relationship type",
        existing_nullable=False,
        existing_server_default=sa.text("'{}'::jsonb"),
    )
    op.alter_column(
        "kg_relationship_type",
        "occurrences",
        existing_type=sa.INTEGER(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "kg_relationship_type",
        "time_updated",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_relationship_type",
        "time_created",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_relationship_type_extraction_staging",
        "definition",
        existing_type=sa.BOOLEAN(),
        comment="Whether this relationship type represents a definition",
        existing_nullable=False,
    )
    op.alter_column(
        "kg_relationship_type_extraction_staging",
        "clustering",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="Clustering information for this relationship type",
        existing_nullable=False,
        existing_server_default=sa.text("'{}'::jsonb"),
    )
    op.alter_column(
        "kg_relationship_type_extraction_staging",
        "occurrences",
        existing_type=sa.INTEGER(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "kg_relationship_type_extraction_staging",
        "transferred",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "kg_relationship_type_extraction_staging",
        "time_created",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_term",
        "entity_types",
        existing_type=postgresql.ARRAY(sa.VARCHAR()),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "kg_term",
        "time_updated",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_term",
        "time_created",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "llm_provider", "provider", existing_type=sa.VARCHAR(), nullable=False
    )
    op.alter_column(
        "llm_provider",
        "is_default_vision_provider",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=True,
    )
    op.alter_column(
        "llm_provider",
        "is_public",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.drop_index(
        "ix_llm_provider__persona_composite",
        table_name="llm_provider__persona",
    )
    op.drop_index(
        "ix_llm_provider__persona_llm_provider_id",
        table_name="llm_provider__persona",
    )
    op.drop_index(
        "ix_llm_provider__persona_persona_id",
        table_name="llm_provider__persona",
    )
    op.drop_constraint(
        "mcp_server__user_group_mcp_server_id_fkey",
        "mcp_server__user_group",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None, "mcp_server__user_group", "mcp_server", ["mcp_server_id"], ["id"]
    )
    op.drop_index("ix_memory_user_id", table_name="memory")
    op.drop_column("milestone", "tenant_id")
    op.drop_constraint(
        "model_configuration_llm_provider_id_name_key",
        "model_configuration",
        type_="unique",
    )
    op.alter_column(
        "oauth_account",
        "refresh_token",
        existing_type=sa.TEXT(),
        nullable=False,
    )
    op.drop_index("ix_oauth_user_token_user_id", table_name="oauth_user_token")
    op.alter_column(
        "persona",
        "num_chunks",
        existing_type=sa.INTEGER(),
        type_=sa.Float(),
        existing_nullable=True,
    )
    op.alter_column(
        "persona",
        "is_default_persona",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "persona",
        "system_prompt",
        existing_type=sa.VARCHAR(length=5000000),
        nullable=True,
    )
    op.alter_column(
        "persona",
        "replace_base_system_prompt",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "persona",
        "task_prompt",
        existing_type=sa.VARCHAR(length=5000000),
        nullable=True,
    )
    op.alter_column(
        "persona",
        "datetime_aware",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.drop_constraint("persona__user_fk", "persona", type_="foreignkey")
    op.create_foreign_key(
        None, "persona", "user", ["user_id"], ["id"], ondelete="CASCADE"
    )
    op.alter_column("persona__user", "user_id", existing_type=sa.UUID(), nullable=True)
    op.drop_constraint(
        "persona__user_user_id_fkey", "persona__user", type_="foreignkey"
    )
    op.create_foreign_key(
        None, "persona__user", "user", ["user_id"], ["id"], ondelete="CASCADE"
    )
    op.drop_column("persona_label", "description")
    op.drop_index(
        "idx_project__user_file_user_file_id", table_name="project__user_file"
    )
    op.alter_column(
        "public_external_user_group",
        "stale",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.drop_index(
        "ix_public_external_user_group_cc_pair_id_stale",
        table_name="public_external_user_group",
    )
    op.drop_index(
        "ix_public_external_user_group_stale",
        table_name="public_external_user_group",
    )
    op.create_index(
        "ix_public_external_group_cc_pair_stale",
        "public_external_user_group",
        ["cc_pair_id", "stale"],
        unique=False,
    )
    op.create_index(
        "ix_public_external_group_stale",
        "public_external_user_group",
        ["stale"],
        unique=False,
    )
    op.alter_column(
        "saml",
        "expires_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
    )
    op.drop_constraint("saml_user_id_fkey", "saml", type_="foreignkey")
    op.create_foreign_key(None, "saml", "user", ["user_id"], ["id"], ondelete="CASCADE")
    op.alter_column(
        "search_doc",
        "source_type",
        existing_type=sa.VARCHAR(length=50),
        type_=sa.Enum(
            "INGESTION_API",
            "SLACK",
            "WEB",
            "GOOGLE_DRIVE",
            "GMAIL",
            "REQUESTTRACKER",
            "GITHUB",
            "GITBOOK",
            "GITLAB",
            "GURU",
            "BOOKSTACK",
            "OUTLINE",
            "CONFLUENCE",
            "JIRA",
            "SLAB",
            "PRODUCTBOARD",
            "FILE",
            "NOTION",
            "ZULIP",
            "LINEAR",
            "HUBSPOT",
            "DOCUMENT360",
            "GONG",
            "GOOGLE_SITES",
            "ZENDESK",
            "LOOPIO",
            "DROPBOX",
            "SHAREPOINT",
            "TEAMS",
            "SALESFORCE",
            "DISCOURSE",
            "AXERO",
            "CLICKUP",
            "MEDIAWIKI",
            "WIKIPEDIA",
            "ASANA",
            "S3",
            "R2",
            "GOOGLE_CLOUD_STORAGE",
            "OCI_STORAGE",
            "XENFORO",
            "NOT_APPLICABLE",
            "DISCORD",
            "FRESHDESK",
            "FIREFLIES",
            "EGNYTE",
            "AIRTABLE",
            "HIGHSPOT",
            "IMAP",
            "BITBUCKET",
            "TESTRAIL",
            "MOCK_CONNECTOR",
            "USER_FILE",
            name="documentsource",
            native_enum=False,
        ),
        existing_nullable=False,
    )
    op.alter_column(
        "search_settings",
        "query_prefix",
        existing_type=sa.VARCHAR(),
        nullable=True,
    )
    op.alter_column(
        "search_settings",
        "passage_prefix",
        existing_type=sa.VARCHAR(),
        nullable=True,
    )
    op.alter_column(
        "search_settings", "status", existing_type=sa.VARCHAR(), nullable=False
    )
    op.alter_column(
        "search_settings",
        "provider_type",
        existing_type=sa.VARCHAR(length=50),
        type_=sa.Enum(
            "OPENAI",
            "COHERE",
            "VOYAGE",
            "GOOGLE",
            "LITELLM",
            "AZURE",
            name="embeddingprovider",
        ),
        existing_nullable=True,
    )
    op.alter_column(
        "search_settings",
        "switchover_type",
        existing_type=sa.VARCHAR(length=11),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "search_settings",
        "embedding_precision",
        existing_type=sa.VARCHAR(length=8),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "search_settings",
        "multipass_indexing",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "search_settings",
        "enable_contextual_rag",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "search_settings",
        "multilingual_expansion",
        existing_type=postgresql.ARRAY(sa.VARCHAR()),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "search_settings",
        "disable_rerank_for_streaming",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "search_settings",
        "num_rerank",
        existing_type=sa.INTEGER(),
        server_default=None,
        existing_nullable=False,
    )
    op.create_index(
        "ix_embedding_model_future_unique",
        "search_settings",
        ["status"],
        unique=True,
        postgresql_where=sa.text("status = 'FUTURE'"),
    )
    op.create_index(
        "ix_embedding_model_present_unique",
        "search_settings",
        ["status"],
        unique=True,
        postgresql_where=sa.text("status = 'PRESENT'"),
    )
    op.alter_column(
        "slack_bot",
        "enabled",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "slack_channel_config",
        "enable_auto_filters",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "slack_channel_config",
        "is_default",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.create_unique_constraint(
        "uq_slack_channel_config_slack_bot_id_default",
        "slack_channel_config",
        ["slack_bot_id", "is_default"],
    )
    op.create_foreign_key(
        None,
        "slack_channel_config__standard_answer_category",
        "slack_channel_config",
        ["slack_channel_config_id"],
        ["id"],
    )
    op.alter_column(
        "standard_answer",
        "match_regex",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "standard_answer",
        "match_any_keywords",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.drop_constraint("standard_answer_keyword_key", "standard_answer", type_="unique")
    op.create_index(
        "unique_keyword_active",
        "standard_answer",
        ["keyword", "active"],
        unique=True,
        postgresql_where=sa.text("active = true"),
    )
    op.alter_column(
        "sync_record",
        "sync_type",
        existing_type=sa.VARCHAR(length=40),
        type_=sa.Enum(
            "DOCUMENT_SET",
            "USER_GROUP",
            "CONNECTOR_DELETION",
            "PRUNING",
            "EXTERNAL_PERMISSIONS",
            "EXTERNAL_GROUP",
            name="synctype",
            native_enum=False,
        ),
        existing_nullable=False,
    )
    op.alter_column(
        "sync_record",
        "sync_status",
        existing_type=sa.VARCHAR(length=40),
        type_=sa.Enum(
            "IN_PROGRESS",
            "SUCCESS",
            "FAILED",
            "CANCELED",
            name="syncstatus",
            native_enum=False,
        ),
        existing_nullable=False,
    )
    op.alter_column(
        "tag",
        "source",
        existing_type=sa.VARCHAR(length=50),
        type_=sa.Enum(
            "INGESTION_API",
            "SLACK",
            "WEB",
            "GOOGLE_DRIVE",
            "GMAIL",
            "REQUESTTRACKER",
            "GITHUB",
            "GITBOOK",
            "GITLAB",
            "GURU",
            "BOOKSTACK",
            "OUTLINE",
            "CONFLUENCE",
            "JIRA",
            "SLAB",
            "PRODUCTBOARD",
            "FILE",
            "NOTION",
            "ZULIP",
            "LINEAR",
            "HUBSPOT",
            "DOCUMENT360",
            "GONG",
            "GOOGLE_SITES",
            "ZENDESK",
            "LOOPIO",
            "DROPBOX",
            "SHAREPOINT",
            "TEAMS",
            "SALESFORCE",
            "DISCOURSE",
            "AXERO",
            "CLICKUP",
            "MEDIAWIKI",
            "WIKIPEDIA",
            "ASANA",
            "S3",
            "R2",
            "GOOGLE_CLOUD_STORAGE",
            "OCI_STORAGE",
            "XENFORO",
            "NOT_APPLICABLE",
            "DISCORD",
            "FRESHDESK",
            "FIREFLIES",
            "EGNYTE",
            "AIRTABLE",
            "HIGHSPOT",
            "IMAP",
            "BITBUCKET",
            "TESTRAIL",
            "MOCK_CONNECTOR",
            "USER_FILE",
            name="documentsource",
            native_enum=False,
        ),
        existing_nullable=False,
    )
    op.alter_column(
        "tag",
        "is_list",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "tool",
        "passthrough_auth",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.drop_index("ix_tool_mcp_server_enabled", table_name="tool")
    op.drop_constraint("tool_user_fk", "tool", type_="foreignkey")
    op.create_foreign_key(None, "tool", "user", ["user_id"], ["id"], ondelete="CASCADE")
    op.add_column(
        "tool_call",
        sa.Column("invoked_persona_id", sa.Integer(), nullable=True),
    )
    op.alter_column(
        "tool_call",
        "turn_number",
        existing_type=sa.INTEGER(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "tool_call",
        "tool_call_id",
        existing_type=sa.VARCHAR(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "tool_call",
        "tool_call_tokens",
        existing_type=sa.INTEGER(),
        server_default=None,
        existing_nullable=False,
    )
    op.create_foreign_key(
        None,
        "tool_call",
        "persona",
        ["invoked_persona_id"],
        ["id"],
        ondelete="SET NULL",
    )
    op.drop_constraint(
        "usage_reports_requestor_user_id_fkey",
        "usage_reports",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "usage_reports",
        "user",
        ["requestor_user_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.alter_column(
        "user",
        "temperature_override_enabled",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=True,
    )
    op.alter_column(
        "user",
        "shortcut_enabled",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "user",
        "use_memories",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "user",
        "visible_assistants",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "user",
        "hidden_assistants",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "user__external_user_group_id",
        "stale",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.drop_index(
        "ix_user__external_user_group_id_cc_pair_id_stale",
        table_name="user__external_user_group_id",
    )
    op.drop_index(
        "ix_user__external_user_group_id_stale",
        table_name="user__external_user_group_id",
    )
    op.create_index(
        "ix_user_external_group_cc_pair_stale",
        "user__external_user_group_id",
        ["cc_pair_id", "stale"],
        unique=False,
    )
    op.create_index(
        "ix_user_external_group_stale",
        "user__external_user_group_id",
        ["stale"],
        unique=False,
    )
    op.drop_constraint(
        "fk_user__external_user_group_id_cc_pair_id",
        "user__external_user_group_id",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "user__external_user_group_id",
        "connector_credential_pair",
        ["cc_pair_id"],
        ["id"],
    )
    op.create_foreign_key(
        None, "user__external_user_group_id", "user", ["user_id"], ["id"]
    )
    op.alter_column(
        "user__user_group",
        "is_curator",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "user__user_group", "user_id", existing_type=sa.UUID(), nullable=True
    )
    op.drop_constraint(
        "user__user_group_user_id_fkey", "user__user_group", type_="foreignkey"
    )
    op.create_foreign_key(
        None,
        "user__user_group",
        "user",
        ["user_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.alter_column(
        "user_file",
        "id",
        existing_type=sa.UUID(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column("user_file", "user_id", existing_type=sa.UUID(), nullable=False)
    op.alter_column(
        "user_file",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=False,
    )
    op.alter_column(
        "user_file", "file_type", existing_type=sa.VARCHAR(), nullable=False
    )
    op.alter_column(
        "user_file",
        "status",
        existing_type=sa.VARCHAR(length=10),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "user_file",
        "needs_project_sync",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.alter_column(
        "user_file",
        "document_id_migrated",
        existing_type=sa.BOOLEAN(),
        server_default=None,
        existing_nullable=False,
    )
    op.create_foreign_key(None, "user_file", "user", ["user_id"], ["id"])
    op.alter_column("user_project", "user_id", existing_type=sa.UUID(), nullable=False)
    op.alter_column(
        "user_project",
        "name",
        existing_type=sa.VARCHAR(length=255),
        nullable=False,
    )
    op.alter_column(
        "user_project",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "user_project",
        "instructions",
        existing_type=sa.VARCHAR(),
        nullable=False,
    )
    op.drop_column("user_project", "display_priority")
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        "user_project",
        sa.Column(
            "display_priority",
            sa.INTEGER(),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.alter_column(
        "user_project",
        "instructions",
        existing_type=sa.VARCHAR(),
        nullable=True,
    )
    op.alter_column(
        "user_project",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "user_project",
        "name",
        existing_type=sa.VARCHAR(length=255),
        nullable=True,
    )
    op.alter_column("user_project", "user_id", existing_type=sa.UUID(), nullable=True)
    op.drop_constraint(None, "user_file", type_="foreignkey")
    op.alter_column(
        "user_file",
        "document_id_migrated",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("true"),
        existing_nullable=False,
    )
    op.alter_column(
        "user_file",
        "needs_project_sync",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.alter_column(
        "user_file",
        "status",
        existing_type=sa.VARCHAR(length=10),
        server_default=sa.text("'PROCESSING'::character varying"),
        existing_nullable=False,
    )
    op.alter_column("user_file", "file_type", existing_type=sa.VARCHAR(), nullable=True)
    op.alter_column(
        "user_file",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=True,
    )
    op.alter_column("user_file", "user_id", existing_type=sa.UUID(), nullable=True)
    op.alter_column(
        "user_file",
        "id",
        existing_type=sa.UUID(),
        server_default=sa.text("gen_random_uuid()"),
        existing_nullable=False,
    )
    op.drop_constraint(None, "user__user_group", type_="foreignkey")
    op.create_foreign_key(
        "user__user_group_user_id_fkey",
        "user__user_group",
        "user",
        ["user_id"],
        ["id"],
    )
    op.alter_column(
        "user__user_group", "user_id", existing_type=sa.UUID(), nullable=False
    )
    op.alter_column(
        "user__user_group",
        "is_curator",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.drop_constraint(None, "user__external_user_group_id", type_="foreignkey")
    op.drop_constraint(None, "user__external_user_group_id", type_="foreignkey")
    op.create_foreign_key(
        "fk_user__external_user_group_id_cc_pair_id",
        "user__external_user_group_id",
        "connector_credential_pair",
        ["cc_pair_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.drop_index(
        "ix_user_external_group_stale",
        table_name="user__external_user_group_id",
    )
    op.drop_index(
        "ix_user_external_group_cc_pair_stale",
        table_name="user__external_user_group_id",
    )
    op.create_index(
        "ix_user__external_user_group_id_stale",
        "user__external_user_group_id",
        ["stale"],
        unique=False,
    )
    op.create_index(
        "ix_user__external_user_group_id_cc_pair_id_stale",
        "user__external_user_group_id",
        ["cc_pair_id", "stale"],
        unique=False,
    )
    op.alter_column(
        "user__external_user_group_id",
        "stale",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.alter_column(
        "user",
        "hidden_assistants",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        server_default=sa.text("'[]'::jsonb"),
        existing_nullable=False,
    )
    op.alter_column(
        "user",
        "visible_assistants",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        server_default=sa.text("'[]'::jsonb"),
        existing_nullable=False,
    )
    op.alter_column(
        "user",
        "use_memories",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("true"),
        existing_nullable=False,
    )
    op.alter_column(
        "user",
        "shortcut_enabled",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.alter_column(
        "user",
        "temperature_override_enabled",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=True,
    )
    op.drop_constraint(None, "usage_reports", type_="foreignkey")
    op.create_foreign_key(
        "usage_reports_requestor_user_id_fkey",
        "usage_reports",
        "user",
        ["requestor_user_id"],
        ["id"],
    )
    op.drop_constraint(None, "tool_call", type_="foreignkey")
    op.alter_column(
        "tool_call",
        "tool_call_tokens",
        existing_type=sa.INTEGER(),
        server_default=sa.text("0"),
        existing_nullable=False,
    )
    op.alter_column(
        "tool_call",
        "tool_call_id",
        existing_type=sa.VARCHAR(),
        server_default=sa.text("''::character varying"),
        existing_nullable=False,
    )
    op.alter_column(
        "tool_call",
        "turn_number",
        existing_type=sa.INTEGER(),
        server_default=sa.text("0"),
        existing_nullable=False,
    )
    op.drop_column("tool_call", "invoked_persona_id")
    op.drop_constraint(None, "tool", type_="foreignkey")
    op.create_foreign_key("tool_user_fk", "tool", "user", ["user_id"], ["id"])
    op.create_index(
        "ix_tool_mcp_server_enabled",
        "tool",
        ["mcp_server_id", "enabled"],
        unique=False,
    )
    op.alter_column(
        "tool",
        "passthrough_auth",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.alter_column(
        "tag",
        "is_list",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.alter_column(
        "tag",
        "source",
        existing_type=sa.Enum(
            "INGESTION_API",
            "SLACK",
            "WEB",
            "GOOGLE_DRIVE",
            "GMAIL",
            "REQUESTTRACKER",
            "GITHUB",
            "GITBOOK",
            "GITLAB",
            "GURU",
            "BOOKSTACK",
            "OUTLINE",
            "CONFLUENCE",
            "JIRA",
            "SLAB",
            "PRODUCTBOARD",
            "FILE",
            "NOTION",
            "ZULIP",
            "LINEAR",
            "HUBSPOT",
            "DOCUMENT360",
            "GONG",
            "GOOGLE_SITES",
            "ZENDESK",
            "LOOPIO",
            "DROPBOX",
            "SHAREPOINT",
            "TEAMS",
            "SALESFORCE",
            "DISCOURSE",
            "AXERO",
            "CLICKUP",
            "MEDIAWIKI",
            "WIKIPEDIA",
            "ASANA",
            "S3",
            "R2",
            "GOOGLE_CLOUD_STORAGE",
            "OCI_STORAGE",
            "XENFORO",
            "NOT_APPLICABLE",
            "DISCORD",
            "FRESHDESK",
            "FIREFLIES",
            "EGNYTE",
            "AIRTABLE",
            "HIGHSPOT",
            "IMAP",
            "BITBUCKET",
            "TESTRAIL",
            "MOCK_CONNECTOR",
            "USER_FILE",
            name="documentsource",
            native_enum=False,
        ),
        type_=sa.VARCHAR(length=50),
        existing_nullable=False,
    )
    op.alter_column(
        "sync_record",
        "sync_status",
        existing_type=sa.Enum(
            "IN_PROGRESS",
            "SUCCESS",
            "FAILED",
            "CANCELED",
            name="syncstatus",
            native_enum=False,
        ),
        type_=sa.VARCHAR(length=40),
        existing_nullable=False,
    )
    op.alter_column(
        "sync_record",
        "sync_type",
        existing_type=sa.Enum(
            "DOCUMENT_SET",
            "USER_GROUP",
            "CONNECTOR_DELETION",
            "PRUNING",
            "EXTERNAL_PERMISSIONS",
            "EXTERNAL_GROUP",
            name="synctype",
            native_enum=False,
        ),
        type_=sa.VARCHAR(length=40),
        existing_nullable=False,
    )
    op.drop_index(
        "unique_keyword_active",
        table_name="standard_answer",
        postgresql_where=sa.text("active = true"),
    )
    op.create_unique_constraint(
        "standard_answer_keyword_key", "standard_answer", ["keyword"]
    )
    op.alter_column(
        "standard_answer",
        "match_any_keywords",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.alter_column(
        "standard_answer",
        "match_regex",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.drop_constraint(
        None,
        "slack_channel_config__standard_answer_category",
        type_="foreignkey",
    )
    op.drop_constraint(
        "uq_slack_channel_config_slack_bot_id_default",
        "slack_channel_config",
        type_="unique",
    )
    op.alter_column(
        "slack_channel_config",
        "is_default",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.alter_column(
        "slack_channel_config",
        "enable_auto_filters",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.alter_column(
        "slack_bot",
        "enabled",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("true"),
        existing_nullable=False,
    )
    op.drop_index(
        "ix_embedding_model_present_unique",
        table_name="search_settings",
        postgresql_where=sa.text("status = 'PRESENT'"),
    )
    op.drop_index(
        "ix_embedding_model_future_unique",
        table_name="search_settings",
        postgresql_where=sa.text("status = 'FUTURE'"),
    )
    op.alter_column(
        "search_settings",
        "num_rerank",
        existing_type=sa.INTEGER(),
        server_default=sa.text("20"),
        existing_nullable=False,
    )
    op.alter_column(
        "search_settings",
        "disable_rerank_for_streaming",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.alter_column(
        "search_settings",
        "multilingual_expansion",
        existing_type=postgresql.ARRAY(sa.VARCHAR()),
        server_default=sa.text("'{}'::character varying[]"),
        existing_nullable=False,
    )
    op.alter_column(
        "search_settings",
        "enable_contextual_rag",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.alter_column(
        "search_settings",
        "multipass_indexing",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.alter_column(
        "search_settings",
        "embedding_precision",
        existing_type=sa.VARCHAR(length=8),
        server_default=sa.text("'FLOAT'::character varying"),
        existing_nullable=False,
    )
    op.alter_column(
        "search_settings",
        "switchover_type",
        existing_type=sa.VARCHAR(length=11),
        server_default=sa.text("'reindex'::character varying"),
        existing_nullable=False,
    )
    op.alter_column(
        "search_settings",
        "provider_type",
        existing_type=sa.Enum(
            "OPENAI",
            "COHERE",
            "VOYAGE",
            "GOOGLE",
            "LITELLM",
            "AZURE",
            name="embeddingprovider",
        ),
        type_=sa.VARCHAR(length=50),
        existing_nullable=True,
    )
    op.alter_column(
        "search_settings", "status", existing_type=sa.VARCHAR(), nullable=True
    )
    op.alter_column(
        "search_settings",
        "passage_prefix",
        existing_type=sa.VARCHAR(),
        nullable=False,
    )
    op.alter_column(
        "search_settings",
        "query_prefix",
        existing_type=sa.VARCHAR(),
        nullable=False,
    )
    op.alter_column(
        "search_doc",
        "source_type",
        existing_type=sa.Enum(
            "INGESTION_API",
            "SLACK",
            "WEB",
            "GOOGLE_DRIVE",
            "GMAIL",
            "REQUESTTRACKER",
            "GITHUB",
            "GITBOOK",
            "GITLAB",
            "GURU",
            "BOOKSTACK",
            "OUTLINE",
            "CONFLUENCE",
            "JIRA",
            "SLAB",
            "PRODUCTBOARD",
            "FILE",
            "NOTION",
            "ZULIP",
            "LINEAR",
            "HUBSPOT",
            "DOCUMENT360",
            "GONG",
            "GOOGLE_SITES",
            "ZENDESK",
            "LOOPIO",
            "DROPBOX",
            "SHAREPOINT",
            "TEAMS",
            "SALESFORCE",
            "DISCOURSE",
            "AXERO",
            "CLICKUP",
            "MEDIAWIKI",
            "WIKIPEDIA",
            "ASANA",
            "S3",
            "R2",
            "GOOGLE_CLOUD_STORAGE",
            "OCI_STORAGE",
            "XENFORO",
            "NOT_APPLICABLE",
            "DISCORD",
            "FRESHDESK",
            "FIREFLIES",
            "EGNYTE",
            "AIRTABLE",
            "HIGHSPOT",
            "IMAP",
            "BITBUCKET",
            "TESTRAIL",
            "MOCK_CONNECTOR",
            "USER_FILE",
            name="documentsource",
            native_enum=False,
        ),
        type_=sa.VARCHAR(length=50),
        existing_nullable=False,
    )
    op.drop_constraint(None, "saml", type_="foreignkey")
    op.create_foreign_key("saml_user_id_fkey", "saml", "user", ["user_id"], ["id"])
    op.alter_column(
        "saml",
        "expires_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
    )
    op.drop_index(
        "ix_public_external_group_stale",
        table_name="public_external_user_group",
    )
    op.drop_index(
        "ix_public_external_group_cc_pair_stale",
        table_name="public_external_user_group",
    )
    op.create_index(
        "ix_public_external_user_group_stale",
        "public_external_user_group",
        ["stale"],
        unique=False,
    )
    op.create_index(
        "ix_public_external_user_group_cc_pair_id_stale",
        "public_external_user_group",
        ["cc_pair_id", "stale"],
        unique=False,
    )
    op.alter_column(
        "public_external_user_group",
        "stale",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.create_index(
        "idx_project__user_file_user_file_id",
        "project__user_file",
        ["user_file_id"],
        unique=False,
    )
    op.add_column(
        "persona_label",
        sa.Column("description", sa.VARCHAR(), autoincrement=False, nullable=True),
    )
    op.drop_constraint(None, "persona__user", type_="foreignkey")
    op.create_foreign_key(
        "persona__user_user_id_fkey",
        "persona__user",
        "user",
        ["user_id"],
        ["id"],
    )
    op.alter_column("persona__user", "user_id", existing_type=sa.UUID(), nullable=False)
    op.drop_constraint(None, "persona", type_="foreignkey")
    op.create_foreign_key("persona__user_fk", "persona", "user", ["user_id"], ["id"])
    op.alter_column(
        "persona",
        "datetime_aware",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("true"),
        existing_nullable=False,
    )
    op.alter_column(
        "persona",
        "task_prompt",
        existing_type=sa.VARCHAR(length=5000000),
        nullable=False,
    )
    op.alter_column(
        "persona",
        "replace_base_system_prompt",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.alter_column(
        "persona",
        "system_prompt",
        existing_type=sa.VARCHAR(length=5000000),
        nullable=False,
    )
    op.alter_column(
        "persona",
        "is_default_persona",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.alter_column(
        "persona",
        "num_chunks",
        existing_type=sa.Float(),
        type_=sa.INTEGER(),
        existing_nullable=True,
    )
    op.create_index(
        "ix_oauth_user_token_user_id",
        "oauth_user_token",
        ["user_id"],
        unique=False,
    )
    op.alter_column(
        "oauth_account",
        "refresh_token",
        existing_type=sa.TEXT(),
        nullable=True,
    )
    op.create_unique_constraint(
        "model_configuration_llm_provider_id_name_key",
        "model_configuration",
        ["llm_provider_id", "name"],
    )
    op.add_column(
        "milestone",
        sa.Column("tenant_id", sa.VARCHAR(), autoincrement=False, nullable=True),
    )
    op.create_index("ix_memory_user_id", "memory", ["user_id"], unique=False)
    op.drop_constraint(None, "mcp_server__user_group", type_="foreignkey")
    op.create_foreign_key(
        "mcp_server__user_group_mcp_server_id_fkey",
        "mcp_server__user_group",
        "mcp_server",
        ["mcp_server_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.create_index(
        "ix_llm_provider__persona_persona_id",
        "llm_provider__persona",
        ["persona_id"],
        unique=False,
    )
    op.create_index(
        "ix_llm_provider__persona_llm_provider_id",
        "llm_provider__persona",
        ["llm_provider_id"],
        unique=False,
    )
    op.create_index(
        "ix_llm_provider__persona_composite",
        "llm_provider__persona",
        ["persona_id", "llm_provider_id"],
        unique=False,
    )
    op.alter_column(
        "llm_provider",
        "is_public",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("true"),
        existing_nullable=False,
    )
    op.alter_column(
        "llm_provider",
        "is_default_vision_provider",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=True,
    )
    op.alter_column(
        "llm_provider", "provider", existing_type=sa.VARCHAR(), nullable=True
    )
    op.alter_column(
        "kg_term",
        "time_created",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_term",
        "time_updated",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_term",
        "entity_types",
        existing_type=postgresql.ARRAY(sa.VARCHAR()),
        server_default=sa.text("'{}'::character varying[]"),
        existing_nullable=False,
    )
    op.alter_column(
        "kg_relationship_type_extraction_staging",
        "time_created",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_relationship_type_extraction_staging",
        "transferred",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.alter_column(
        "kg_relationship_type_extraction_staging",
        "occurrences",
        existing_type=sa.INTEGER(),
        server_default=sa.text("1"),
        existing_nullable=False,
    )
    op.alter_column(
        "kg_relationship_type_extraction_staging",
        "clustering",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="Clustering information for this relationship type",
        existing_nullable=False,
        existing_server_default=sa.text("'{}'::jsonb"),
    )
    op.alter_column(
        "kg_relationship_type_extraction_staging",
        "definition",
        existing_type=sa.BOOLEAN(),
        comment=None,
        existing_comment="Whether this relationship type represents a definition",
        existing_nullable=False,
    )
    op.alter_column(
        "kg_relationship_type",
        "time_created",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_relationship_type",
        "time_updated",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_relationship_type",
        "occurrences",
        existing_type=sa.INTEGER(),
        server_default=sa.text("1"),
        existing_nullable=False,
    )
    op.alter_column(
        "kg_relationship_type",
        "clustering",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="Clustering information for this relationship type",
        existing_nullable=False,
        existing_server_default=sa.text("'{}'::jsonb"),
    )
    op.alter_column(
        "kg_relationship_type",
        "definition",
        existing_type=sa.BOOLEAN(),
        comment=None,
        existing_comment="Whether this relationship type represents a definition",
        existing_nullable=False,
    )
    op.drop_constraint(
        "uq_kg_relationship_source_target_type",
        "kg_relationship_extraction_staging",
        type_="unique",
    )
    op.drop_index(
        "ix_kg_relationship_type",
        table_name="kg_relationship_extraction_staging",
    )
    op.drop_index(
        "ix_kg_relationship_nodes",
        table_name="kg_relationship_extraction_staging",
    )
    op.create_unique_constraint(
        "uq_kg_relationship_extraction_staging_source_target_type",
        "kg_relationship_extraction_staging",
        ["source_node", "target_node", "type"],
    )
    op.create_index(
        "ix_kg_relationship_extraction_staging_nodes",
        "kg_relationship_extraction_staging",
        ["source_node", "target_node"],
        unique=False,
    )
    op.alter_column(
        "kg_relationship_extraction_staging",
        "time_created",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_relationship_extraction_staging",
        "transferred",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.alter_column(
        "kg_relationship_extraction_staging",
        "occurrences",
        existing_type=sa.INTEGER(),
        server_default=sa.text("1"),
        existing_nullable=False,
    )
    op.alter_column(
        "kg_relationship_extraction_staging",
        "source_document",
        existing_type=sa.VARCHAR(),
        nullable=False,
    )
    op.alter_column(
        "kg_relationship",
        "time_created",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_relationship",
        "time_updated",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_relationship",
        "occurrences",
        existing_type=sa.INTEGER(),
        server_default=sa.text("1"),
        existing_nullable=False,
    )
    op.alter_column(
        "kg_relationship",
        "source_document",
        existing_type=sa.VARCHAR(),
        nullable=False,
    )
    op.alter_column(
        "kg_entity_type",
        "clustering",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="Clustering information for this entity type",
        existing_nullable=False,
        existing_server_default=sa.text("'{}'::jsonb"),
    )
    op.alter_column(
        "kg_entity_type",
        "time_created",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_entity_type",
        "time_updated",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_entity_type",
        "occurrences",
        existing_type=sa.INTEGER(),
        server_default=sa.text("1"),
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity_type",
        "attributes",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        nullable=False,
        comment=None,
        existing_comment="Filtering based on document attribute",
        existing_server_default=sa.text("'{}'::jsonb"),
    )
    op.create_foreign_key(
        "kg_entity_extraction_staging_document_id_fkey",
        "kg_entity_extraction_staging",
        "document",
        ["document_id"],
        ["id"],
    )
    op.drop_index("ix_entity_type_acl", table_name="kg_entity_extraction_staging")
    op.drop_index("ix_entity_name_search", table_name="kg_entity_extraction_staging")
    op.create_index(
        "ix_entity_extraction_staging_name_search",
        "kg_entity_extraction_staging",
        ["name", "entity_type_id_name"],
        unique=False,
    )
    op.create_index(
        "ix_entity_extraction_staging_acl",
        "kg_entity_extraction_staging",
        ["entity_type_id_name", "acl"],
        unique=False,
    )
    op.alter_column(
        "kg_entity_extraction_staging",
        "time_created",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_entity_extraction_staging",
        "event_time",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Time of the event being processed",
        existing_nullable=True,
    )
    op.alter_column(
        "kg_entity_extraction_staging",
        "boosts",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        server_default=sa.text("'{}'::jsonb"),
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity_extraction_staging",
        "acl",
        existing_type=postgresql.ARRAY(sa.VARCHAR()),
        server_default=sa.text("'{}'::character varying[]"),
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity_extraction_staging",
        "occurrences",
        existing_type=sa.INTEGER(),
        server_default=sa.text("1"),
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity_extraction_staging",
        "keywords",
        existing_type=postgresql.ARRAY(sa.VARCHAR()),
        server_default=sa.text("'{}'::character varying[]"),
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity_extraction_staging",
        "alternative_names",
        existing_type=postgresql.ARRAY(sa.VARCHAR()),
        server_default=sa.text("'{}'::character varying[]"),
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity_extraction_staging",
        "attributes",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="Attributes for this entity",
        existing_nullable=False,
        existing_server_default=sa.text("'{}'::jsonb"),
    )
    op.create_foreign_key(
        "kg_entity_document_id_fkey",
        "kg_entity",
        "document",
        ["document_id"],
        ["id"],
    )
    op.create_unique_constraint(
        "uq_kg_entity_name_type_doc",
        "kg_entity",
        ["name", "entity_type_id_name", "document_id"],
    )
    op.create_index(
        "idx_kg_entity_normalization_trigrams",
        "kg_entity",
        ["name_trigrams"],
        unique=False,
    )
    op.create_index(
        "idx_kg_entity_clustering_trigrams",
        "kg_entity",
        ["name"],
        unique=False,
    )
    op.alter_column(
        "kg_entity",
        "time_created",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_entity",
        "time_updated",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "kg_entity",
        "event_time",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Time of the event being processed",
        existing_nullable=True,
    )
    op.alter_column(
        "kg_entity",
        "boosts",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        server_default=sa.text("'{}'::jsonb"),
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity",
        "acl",
        existing_type=postgresql.ARRAY(sa.VARCHAR()),
        server_default=sa.text("'{}'::character varying[]"),
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity",
        "occurrences",
        existing_type=sa.INTEGER(),
        server_default=sa.text("1"),
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity",
        "keywords",
        existing_type=postgresql.ARRAY(sa.VARCHAR()),
        server_default=sa.text("'{}'::character varying[]"),
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity",
        "alternative_names",
        existing_type=postgresql.ARRAY(sa.VARCHAR()),
        server_default=sa.text("'{}'::character varying[]"),
        existing_nullable=False,
    )
    op.alter_column(
        "kg_entity",
        "attributes",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="Attributes for this entity",
        existing_nullable=False,
        existing_server_default=sa.text("'{}'::jsonb"),
    )
    op.create_index(
        "ix_internet_search_provider_is_active",
        "internet_search_provider",
        ["is_active"],
        unique=False,
    )
    op.alter_column(
        "internet_search_provider",
        "is_active",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.create_index(
        "ix_internet_content_provider_is_active",
        "internet_content_provider",
        ["is_active"],
        unique=False,
    )
    op.alter_column(
        "internet_content_provider",
        "is_active",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.drop_constraint(None, "inputprompt__user", type_="foreignkey")
    op.drop_constraint(None, "inputprompt__user", type_="foreignkey")
    op.create_foreign_key(
        "inputprompt__user_input_prompt_id_fkey",
        "inputprompt__user",
        "inputprompt",
        ["input_prompt_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        "inputprompt__user_user_id_fkey",
        "inputprompt__user",
        "user",
        ["user_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.alter_column(
        "inputprompt__user",
        "user_id",
        existing_type=sa.Integer(),
        type_=sa.UUID(),
        nullable=False,
    )
    op.drop_constraint(None, "inputprompt", type_="foreignkey")
    op.create_foreign_key(
        "inputprompt_user_id_fkey", "inputprompt", "user", ["user_id"], ["id"]
    )
    op.create_index(
        "ix_index_attempt_status", "index_attempt", ["status"], unique=False
    )
    op.alter_column(
        "index_attempt",
        "last_heartbeat_value",
        existing_type=sa.INTEGER(),
        server_default=sa.text("0"),
        existing_nullable=False,
    )
    op.alter_column(
        "index_attempt",
        "heartbeat_counter",
        existing_type=sa.INTEGER(),
        server_default=sa.text("0"),
        existing_nullable=False,
    )
    op.alter_column(
        "index_attempt",
        "last_batches_completed_count",
        existing_type=sa.INTEGER(),
        server_default=sa.text("0"),
        existing_nullable=False,
    )
    op.alter_column(
        "index_attempt",
        "total_chunks",
        existing_type=sa.INTEGER(),
        server_default=sa.text("0"),
        existing_nullable=False,
    )
    op.alter_column(
        "index_attempt",
        "total_failures_batch_level",
        existing_type=sa.INTEGER(),
        server_default=sa.text("0"),
        existing_nullable=False,
    )
    op.alter_column(
        "index_attempt",
        "completed_batches",
        existing_type=sa.INTEGER(),
        server_default=sa.text("0"),
        existing_nullable=False,
    )
    op.alter_column(
        "index_attempt",
        "cancellation_requested",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.alter_column(
        "index_attempt",
        "error_msg",
        existing_type=sa.Text(),
        type_=sa.VARCHAR(),
        existing_nullable=True,
    )
    op.alter_column(
        "file_record", "object_key", existing_type=sa.VARCHAR(), nullable=True
    )
    op.alter_column(
        "file_record", "bucket_name", existing_type=sa.VARCHAR(), nullable=True
    )
    op.alter_column(
        "file_record",
        "file_type",
        existing_type=sa.VARCHAR(),
        server_default=sa.text("'text/plain'::character varying"),
        existing_nullable=False,
    )
    op.alter_column(
        "file_record",
        "file_origin",
        existing_type=sa.VARCHAR(),
        server_default=sa.text("'connector'::character varying"),
        existing_nullable=False,
    )
    op.alter_column(
        "embedding_provider",
        "provider_type",
        existing_type=sa.Enum(
            "OPENAI",
            "COHERE",
            "VOYAGE",
            "GOOGLE",
            "LITELLM",
            "AZURE",
            name="embeddingprovider",
        ),
        type_=sa.VARCHAR(length=50),
        existing_nullable=False,
    )
    op.drop_constraint(None, "document_set__user", type_="foreignkey")
    op.create_foreign_key(
        "document_set__user_user_id_fkey",
        "document_set__user",
        "user",
        ["user_id"],
        ["id"],
    )
    op.alter_column(
        "document_set__user",
        "user_id",
        existing_type=sa.UUID(),
        nullable=False,
    )
    op.drop_constraint(None, "document_set", type_="foreignkey")
    op.create_foreign_key(
        "document_set_user_id_fkey",
        "document_set",
        "user",
        ["user_id"],
        ["id"],
    )
    op.create_index(
        "ix_document_by_connector_credential_pair_pkey__connecto_27dc",
        "document_by_connector_credential_pair",
        ["connector_id", "credential_id"],
        unique=False,
    )
    op.alter_column(
        "document",
        "kg_stage",
        existing_type=sa.VARCHAR(),
        nullable=True,
        comment=None,
        existing_comment="Status of knowledge graph extraction for this document",
    )
    op.alter_column("document", "is_public", existing_type=sa.BOOLEAN(), nullable=True)
    op.alter_column(
        "document",
        "last_modified",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        server_default=sa.text("now()"),
        existing_nullable=False,
    )
    op.alter_column(
        "credential",
        "curator_public",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        existing_nullable=False,
    )
    op.alter_column(
        "credential",
        "credential_json",
        existing_type=postgresql.BYTEA(),
        nullable=True,
    )
    op.alter_column(
        "credential",
        "source",
        existing_type=sa.Enum(
            "INGESTION_API",
            "SLACK",
            "WEB",
            "GOOGLE_DRIVE",
            "GMAIL",
            "REQUESTTRACKER",
            "GITHUB",
            "GITBOOK",
            "GITLAB",
            "GURU",
            "BOOKSTACK",
            "OUTLINE",
            "CONFLUENCE",
            "JIRA",
            "SLAB",
            "PRODUCTBOARD",
            "FILE",
            "NOTION",
            "ZULIP",
            "LINEAR",
            "HUBSPOT",
            "DOCUMENT360",
            "GONG",
            "GOOGLE_SITES",
            "ZENDESK",
            "LOOPIO",
            "DROPBOX",
            "SHAREPOINT",
            "TEAMS",
            "SALESFORCE",
            "DISCOURSE",
            "AXERO",
            "CLICKUP",
            "MEDIAWIKI",
            "WIKIPEDIA",
            "ASANA",
            "S3",
            "R2",
            "GOOGLE_CLOUD_STORAGE",
            "OCI_STORAGE",
            "XENFORO",
            "NOT_APPLICABLE",
            "DISCORD",
            "FRESHDESK",
            "FIREFLIES",
            "EGNYTE",
            "AIRTABLE",
            "HIGHSPOT",
            "IMAP",
            "BITBUCKET",
            "TESTRAIL",
            "MOCK_CONNECTOR",
            "USER_FILE",
            name="documentsource",
            native_enum=False,
        ),
        type_=sa.VARCHAR(length=100),
        nullable=True,
    )
    op.drop_index(
        op.f("ix_connector_credential_pair_last_pruned"),
        table_name="connector_credential_pair",
    )
    op.alter_column(
        "connector_credential_pair",
        "in_repeated_error_state",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        nullable=True,
    )
    op.alter_column(
        "connector_credential_pair",
        "id",
        existing_type=sa.INTEGER(),
        server_default=sa.text("nextval('connector_credential_pair_id_seq'::regclass)"),
        existing_nullable=False,
    )
    op.alter_column(
        "connector_credential_pair",
        "is_user_file",
        existing_type=sa.BOOLEAN(),
        nullable=True,
    )
    op.alter_column(
        "connector",
        "kg_processing_enabled",
        existing_type=sa.BOOLEAN(),
        server_default=sa.text("false"),
        nullable=True,
        comment=None,
        existing_comment="Whether this connector should extract knowledge graph entities",
    )
    op.alter_column(
        "connector",
        "input_type",
        existing_type=sa.Enum(
            "LOAD_STATE",
            "POLL",
            "EVENT",
            "SLIM_RETRIEVAL",
            name="inputtype",
            native_enum=False,
        ),
        type_=sa.VARCHAR(length=10),
        existing_nullable=True,
    )
    op.alter_column(
        "connector",
        "source",
        existing_type=sa.Enum(
            "INGESTION_API",
            "SLACK",
            "WEB",
            "GOOGLE_DRIVE",
            "GMAIL",
            "REQUESTTRACKER",
            "GITHUB",
            "GITBOOK",
            "GITLAB",
            "GURU",
            "BOOKSTACK",
            "OUTLINE",
            "CONFLUENCE",
            "JIRA",
            "SLAB",
            "PRODUCTBOARD",
            "FILE",
            "NOTION",
            "ZULIP",
            "LINEAR",
            "HUBSPOT",
            "DOCUMENT360",
            "GONG",
            "GOOGLE_SITES",
            "ZENDESK",
            "LOOPIO",
            "DROPBOX",
            "SHAREPOINT",
            "TEAMS",
            "SALESFORCE",
            "DISCOURSE",
            "AXERO",
            "CLICKUP",
            "MEDIAWIKI",
            "WIKIPEDIA",
            "ASANA",
            "S3",
            "R2",
            "GOOGLE_CLOUD_STORAGE",
            "OCI_STORAGE",
            "XENFORO",
            "NOT_APPLICABLE",
            "DISCORD",
            "FRESHDESK",
            "FIREFLIES",
            "EGNYTE",
            "AIRTABLE",
            "HIGHSPOT",
            "IMAP",
            "BITBUCKET",
            "TESTRAIL",
            "MOCK_CONNECTOR",
            "USER_FILE",
            name="documentsource",
            native_enum=False,
        ),
        type_=sa.VARCHAR(length=50),
        existing_nullable=False,
    )
    op.alter_column(
        "chunk_stats",
        "last_modified",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        server_default=sa.text("now()"),
        existing_nullable=False,
    )
    op.add_column(
        "chat_session",
        sa.Column(
            "description_tsv",
            postgresql.TSVECTOR(),
            sa.Computed(
                "to_tsvector('english'::regconfig, COALESCE(description, ''::text))",
                persisted=True,
            ),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.create_index(
        "ix_chat_session_project_id",
        "chat_session",
        ["project_id"],
        unique=False,
    )
    op.create_index(
        "idx_chat_session_desc_tsv",
        "chat_session",
        ["description_tsv"],
        unique=False,
    )
    op.alter_column(
        "chat_session",
        "id",
        existing_type=sa.UUID(),
        server_default=sa.text("gen_random_uuid()"),
        existing_nullable=False,
    )
    op.add_column(
        "chat_message",
        sa.Column(
            "message_tsv",
            postgresql.TSVECTOR(),
            sa.Computed("to_tsvector('english'::regconfig, message)", persisted=True),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.drop_constraint(None, "chat_message", type_="foreignkey")
    op.create_foreign_key(
        "chat_message_chat_session_id_fkey",
        "chat_message",
        "chat_session",
        ["chat_session_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.create_index(
        "idx_chat_message_tsv", "chat_message", ["message_tsv"], unique=False
    )
    op.create_unique_constraint("chat_message_id_key", "chat_message", ["id"])
    op.alter_column(
        "chat_message",
        "message_type",
        existing_type=sa.Enum(
            "SYSTEM",
            "USER",
            "ASSISTANT",
            "TOOL_CALL",
            "TOOL_CALL_RESPONSE",
            name="messagetype",
            native_enum=False,
        ),
        type_=sa.VARCHAR(length=9),
        existing_nullable=False,
    )
    op.alter_column(
        "chat_message",
        "chat_session_id",
        existing_type=sa.UUID(),
        nullable=True,
    )
    op.drop_constraint(None, "api_key", type_="foreignkey")
    op.drop_constraint(None, "api_key", type_="foreignkey")
    op.create_table(
        "alembic_version",
        sa.Column(
            "version_num",
            sa.VARCHAR(length=32),
            autoincrement=False,
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("version_num", name="alembic_version_pkc"),
    )
    op.drop_table("celery_tasksetmeta")
    op.drop_table("celery_taskmeta")
    op.drop_table("persona__persona")
    op.drop_table("tenant_anonymous_user_path")
    op.drop_table("user_tenant_mapping", schema="public")
    op.drop_table("available_tenant")
    # ### end Alembic commands ###

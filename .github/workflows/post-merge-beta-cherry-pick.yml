name: Post-Merge Beta Cherry-Pick
concurrency:
  group: Post-Merge-Beta-Cherry-Pick-${{ github.workflow }}-${{ github.ref_name }}-${{ github.run_id }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  cherry-pick-to-latest-release:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Resolve merged PR and checkbox state
        id: gate
        env:
          GH_TOKEN: ${{ github.token }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          pr_number="$(gh api "repos/${GITHUB_REPOSITORY}/commits/${COMMIT_SHA}/pulls" --jq '.[] | select(.merged_at != null and .base.ref == "main") | .number' | head -n 1)"

          if [ -z "$pr_number" ]; then
            echo "No merged PR associated with commit ${COMMIT_SHA}; skipping."
            echo "should_cherrypick=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          pr_body="$(gh api "repos/${GITHUB_REPOSITORY}/pulls/${pr_number}" --jq '.body // ""')"
          echo "pr_number=$pr_number" >> "$GITHUB_OUTPUT"

          if echo "$pr_body" | grep -qiE "\\[x\\][[:space:]]*(\\[[^]]+\\][[:space:]]*)?I have considered whether this PR needs to be cherry[- ]picked to the latest beta branch"; then
            echo "should_cherrypick=true" >> "$GITHUB_OUTPUT"
            echo "Cherry-pick checkbox checked for PR #${pr_number}."
            exit 0
          fi

          echo "should_cherrypick=false" >> "$GITHUB_OUTPUT"
          echo "Cherry-pick checkbox not checked for PR #${pr_number}. Skipping."

      - name: Checkout repository
        if: steps.gate.outputs.should_cherrypick == 'true'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: true
          ref: main

      - name: Setup Go
        if: steps.gate.outputs.should_cherrypick == 'true'
        uses: actions/setup-go@v5
        with:
          go-version-file: tools/ods/go.mod

      - name: Configure git identity
        if: steps.gate.outputs.should_cherrypick == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine commits to cherry-pick
        if: steps.gate.outputs.should_cherrypick == 'true'
        id: commits
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.gate.outputs.pr_number }}
        run: |
          merge_commit_sha="$(gh api "repos/${GITHUB_REPOSITORY}/pulls/${PR_NUMBER}" --jq '.merge_commit_sha // ""')"
          commit_shas="$(gh api "repos/${GITHUB_REPOSITORY}/pulls/${PR_NUMBER}/commits" --paginate --jq '.[] | select((.parents | length) == 1) | .sha' | tr '\n' ' ' | sed -E 's/[[:space:]]+$//')"

          if [ -z "$commit_shas" ]; then
            if [ -z "$merge_commit_sha" ]; then
              echo "::error::Unable to determine commits to cherry-pick for PR #${PR_NUMBER}."
              exit 1
            fi
            commit_shas="$merge_commit_sha"
          fi

          echo "commit_shas=$commit_shas" >> "$GITHUB_OUTPUT"
          echo "Commits selected for cherry-pick: $commit_shas"

      - name: Create cherry-pick PR to latest release
        if: steps.gate.outputs.should_cherrypick == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_TOKEN: ${{ github.token }}
          COMMIT_SHAS: ${{ steps.commits.outputs.commit_shas }}
        run: |
          read -r -a commits <<< "$COMMIT_SHAS"
          go run ./tools/ods cherry-pick "${commits[@]}" --latest-release --yes --no-verify

name: Reusable Nightly LLM Provider Chat Tests

on:
  workflow_call:
    inputs:
      providers_json:
        description: >
          JSON array of provider configs. Each item supports:
          provider, models (CSV or array), api_key_secret, strict, api_base, custom_config_json.
        required: true
        type: string
    secrets:
      DOCKER_USERNAME:
        required: true
      DOCKER_TOKEN:
        required: true

permissions:
  contents: read

jobs:
  prepare-provider-matrix:
    # NOTE: Keep this cheap and fail before image builds if required inputs are missing.
    runs-on: ubuntu-slim
    timeout-minutes: 5
    outputs:
      matrix: ${{ steps.build-matrix.outputs.matrix }}
    steps:
      - name: Validate inputs and generate provider matrix
        id: build-matrix
        env:
          INPUT_PROVIDERS_JSON: ${{ inputs.providers_json }}
        run: |
          python3 - <<'PY'
          import json
          import os
          import sys

          def fail(message: str) -> None:
              print(message)
              sys.exit(1)

          def as_bool(value: object, default: bool = False) -> bool:
              if value is None:
                  return default
              if isinstance(value, bool):
                  return value
              return str(value).strip().lower() in {"1", "true", "yes", "on"}

          def parse_models(raw: object, label: str) -> str:
              if isinstance(raw, str):
                  models = [part.strip() for part in raw.split(",") if part.strip()]
              elif isinstance(raw, list):
                  models = [str(item).strip() for item in raw if str(item).strip()]
              else:
                  raise ValueError(
                      f"'models' for {label} must be a CSV string or a JSON array"
                  )

              if not models:
                  raise ValueError(
                      f"'models' must contain at least one model for {label}"
                  )
              return ",".join(models)

          def parse_custom_config_json(raw: object, label: str) -> str:
              if raw is None:
                  return ""

              if isinstance(raw, (dict, list)):
                  return json.dumps(raw, separators=(",", ":"))

              raw_text = str(raw).strip()
              if not raw_text:
                  return ""

              try:
                  parsed = json.loads(raw_text)
              except json.JSONDecodeError as ex:
                  raise ValueError(
                      f"'custom_config_json' for {label} must be valid JSON: {ex}"
                  )

              return json.dumps(parsed, separators=(",", ":"))

          providers_json = os.environ.get("INPUT_PROVIDERS_JSON", "").strip()
          if not providers_json:
              fail("Input 'providers_json' must be non-empty")

          try:
              parsed = json.loads(providers_json)
          except json.JSONDecodeError as ex:
              fail(f"Input 'providers_json' must be valid JSON: {ex}")

          if not isinstance(parsed, list):
              fail("Input 'providers_json' must be a JSON array")

          entries: list[dict[str, str]] = []

          for i, item in enumerate(parsed, start=1):
              label = f"providers_json[{i}]"
              provider_for_entry = f"invalid_provider_{i}"
              models_csv = ""
              strict = "true"
              api_base = ""
              custom_config_json = ""
              api_key_secret = ""
              validation_error = ""

              try:
                  if not isinstance(item, dict):
                      raise ValueError(f"{label} must be a JSON object")

                  provider = str(item.get("provider", "")).strip().lower()
                  if not provider:
                      raise ValueError(f"{label}.provider must be non-empty")
                  provider_for_entry = provider

                  models_csv = parse_models(item.get("models", ""), label)
                  strict = (
                      "true"
                      if as_bool(item.get("strict", True), default=True)
                      else "false"
                  )
                  api_base = str(item.get("api_base", "")).strip()
                  custom_config_json = parse_custom_config_json(
                      item.get("custom_config_json", ""),
                      label,
                  )
                  api_key_secret = str(item.get("api_key_secret", "")).strip()

                  if provider != "ollama_chat" and not api_key_secret:
                      raise ValueError(
                          f"{label}.api_key_secret must be set for provider '{provider}'"
                      )
              except ValueError as ex:
                  validation_error = str(ex)

              entries.append(
                  {
                      "provider": provider_for_entry,
                      "models": models_csv,
                      "strict": strict,
                      "api_base": api_base,
                      "custom_config_json": custom_config_json,
                      "api_key_secret": api_key_secret,
                      "validation_error": validation_error,
                  }
              )

          if not entries:
              fail("No provider entries were generated from 'providers_json'.")

          valid_entries = [entry for entry in entries if not entry["validation_error"]]
          if not valid_entries:
              errors = " | ".join(entry["validation_error"] for entry in entries)
              fail(
                  "No valid provider entries were found in 'providers_json'. "
                  f"Errors: {errors}"
              )

          matrix_json = json.dumps({"include": entries}, separators=(",", ":"))
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
              f.write(f"matrix={matrix_json}\n")
          PY

  build-backend-image:
    needs: [prepare-provider-matrix]
    runs-on:
      [
        runs-on,
        runner=1cpu-linux-arm64,
        "run-id=${{ github.run_id }}-build-backend-image",
        "extras=ecr-cache",
      ]
    timeout-minutes: 45
    steps:
      - uses: runs-on/action@cd2b598b0515d39d78c38a02d529db87d2196d1e # ratchet:runs-on/action@v2

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6
        with:
          persist-credentials: false

      - name: Build backend image
        uses: ./.github/actions/build-backend-image
        with:
          runs-on-ecr-cache: ${{ env.RUNS_ON_ECR_CACHE }}
          ref-name: ${{ github.ref_name }}
          pr-number: ${{ github.event.pull_request.number }}
          github-sha: ${{ github.sha }}
          run-id: ${{ github.run_id }}
          docker-username: ${{ secrets.DOCKER_USERNAME }}
          docker-token: ${{ secrets.DOCKER_TOKEN }}
          docker-no-cache: ${{ vars.DOCKER_NO_CACHE == 'true' && 'true' || 'false' }}

  build-model-server-image:
    needs: [prepare-provider-matrix]
    runs-on:
      [
        runs-on,
        runner=1cpu-linux-arm64,
        "run-id=${{ github.run_id }}-build-model-server-image",
        "extras=ecr-cache",
      ]
    timeout-minutes: 45
    steps:
      - uses: runs-on/action@cd2b598b0515d39d78c38a02d529db87d2196d1e # ratchet:runs-on/action@v2

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6
        with:
          persist-credentials: false

      - name: Build model server image
        uses: ./.github/actions/build-model-server-image
        with:
          runs-on-ecr-cache: ${{ env.RUNS_ON_ECR_CACHE }}
          ref-name: ${{ github.ref_name }}
          pr-number: ${{ github.event.pull_request.number }}
          github-sha: ${{ github.sha }}
          run-id: ${{ github.run_id }}
          docker-username: ${{ secrets.DOCKER_USERNAME }}
          docker-token: ${{ secrets.DOCKER_TOKEN }}

  build-integration-image:
    needs: [prepare-provider-matrix]
    runs-on:
      [
        runs-on,
        runner=2cpu-linux-arm64,
        "run-id=${{ github.run_id }}-build-integration-image",
        "extras=ecr-cache",
      ]
    timeout-minutes: 45
    steps:
      - uses: runs-on/action@cd2b598b0515d39d78c38a02d529db87d2196d1e # ratchet:runs-on/action@v2

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6
        with:
          persist-credentials: false

      - name: Build integration image
        uses: ./.github/actions/build-integration-image
        with:
          runs-on-ecr-cache: ${{ env.RUNS_ON_ECR_CACHE }}
          ref-name: ${{ github.ref_name }}
          pr-number: ${{ github.event.pull_request.number }}
          github-sha: ${{ github.sha }}
          run-id: ${{ github.run_id }}
          docker-username: ${{ secrets.DOCKER_USERNAME }}
          docker-token: ${{ secrets.DOCKER_TOKEN }}

  provider-chat-tests:
    needs:
      [
        prepare-provider-matrix,
        build-backend-image,
        build-model-server-image,
        build-integration-image,
      ]
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare-provider-matrix.outputs.matrix) }}
    runs-on:
      - runs-on
      - runner=4cpu-linux-arm64
      - "run-id=${{ github.run_id }}-nightly-provider-chat-${{ strategy['job-index'] }}"
      - extras=ecr-cache
    timeout-minutes: 45
    env:
      MATRIX_PROVIDER_API_KEY: ${{ matrix.api_key_secret != '' && secrets[matrix.api_key_secret] || '' }}
    steps:
      - uses: runs-on/action@cd2b598b0515d39d78c38a02d529db87d2196d1e # ratchet:runs-on/action@v2

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # ratchet:actions/checkout@v6
        with:
          persist-credentials: false

      - name: Validate provider configuration for this matrix entry
        env:
          PROVIDER: ${{ matrix.provider }}
          MODELS: ${{ matrix.models }}
          API_KEY_SECRET_NAME: ${{ matrix.api_key_secret }}
          API_KEY_VALUE: ${{ env.MATRIX_PROVIDER_API_KEY }}
          VALIDATION_ERROR: ${{ matrix.validation_error }}
        run: |
          if [ -n "${VALIDATION_ERROR}" ]; then
            echo "Provider '${PROVIDER}' has invalid configuration: ${VALIDATION_ERROR}"
            exit 1
          fi

          if [ -z "${MODELS}" ]; then
            echo "Provider '${PROVIDER}' has an empty models list."
            exit 1
          fi

          if [ "${PROVIDER}" != "ollama_chat" ] && [ -z "${API_KEY_VALUE}" ]; then
            if [ -z "${API_KEY_SECRET_NAME}" ]; then
              echo "Provider '${PROVIDER}' requires an API key secret."
            else
              echo "Provider '${PROVIDER}' requires secret '${API_KEY_SECRET_NAME}', but it is empty or not passed to this workflow."
            fi
            exit 1
          fi

      - name: Run nightly provider chat test
        uses: ./.github/actions/run-nightly-provider-chat-test
        with:
          provider: ${{ matrix.provider }}
          models: ${{ matrix.models }}
          provider-api-key: ${{ env.MATRIX_PROVIDER_API_KEY }}
          strict: ${{ matrix.strict }}
          api-base: ${{ matrix.api_base }}
          custom-config-json: ${{ matrix.custom_config_json }}
          runs-on-ecr-cache: ${{ env.RUNS_ON_ECR_CACHE }}
          run-id: ${{ github.run_id }}
          docker-username: ${{ secrets.DOCKER_USERNAME }}
          docker-token: ${{ secrets.DOCKER_TOKEN }}

      - name: Dump API server logs
        if: always()
        run: |
          cd deployment/docker_compose
          docker compose logs --no-color api_server > $GITHUB_WORKSPACE/api_server.log || true

      - name: Dump all-container logs
        if: always()
        run: |
          cd deployment/docker_compose
          docker compose logs --no-color > $GITHUB_WORKSPACE/docker-compose.log || true

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: docker-all-logs-nightly-${{ matrix.provider }}-${{ strategy['job-index'] }}
          path: |
            ${{ github.workspace }}/api_server.log
            ${{ github.workspace }}/docker-compose.log

      - name: Stop Docker containers
        if: always()
        run: |
          cd deployment/docker_compose
          docker compose down -v

name: Ensure PR references Linear

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  linear-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR body for Linear link or override
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          # Skip check for dependabot PRs
          if [ "$PR_AUTHOR" = "dependabot[bot]" ]; then
            echo "PR is from dependabot. Skipping Linear check."
            exit 0
          fi

          # Looking for "https://linear.app" in the body
          if echo "$PR_BODY" | grep -qE "https://linear\.app"; then
            echo "Found a Linear link. Check passed."
            exit 0
          fi

          # Looking for a checked override: "[x] Override Linear Check"
          if echo "$PR_BODY" | grep -q "\[x\].*Override Linear Check"; then
            echo "Override box is checked. Check passed."
            exit 0
          fi

          # Otherwise, fail the run
          echo "No Linear link or override found in the PR description."
          exit 1
